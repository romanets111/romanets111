import sqlite3
import os
import re
from datetime import datetime, timezone, timedelta
from vkbottle.bot import BotLabeler, Message
from vkbottle import Bot
from vkbottle.bot import rules
from vkbottle import BaseStateGroup

# –ú–æ—Å–∫–æ–≤—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
MSK_TZ = timezone(timedelta(hours=3))

def get_moscow_time():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ"""
    return datetime.now(MSK_TZ)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
token = "vk1.a.BD8yNPKHpTb6W0_QHq-hNpmNVjfnT0eKhexRxhkmLIQhVzPU6ULHqkcA7h5ptN03ieLd8cUKC1Mml3kN8gZpiJw4O9O7te90aVE48v55oMqV9c1EPkY6LFULpxOVj6eZqP31qplRvr9-I1TBVoquaWbv_R1NvTcm2O-eutLw7183g1RkKiUjl3Ng8RIHL1o78yAzg8rDRDEwQAsUWym2aA"
if not token:
    print("‚ùå –û–®–ò–ë–ö–ê: VK_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
    print("–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ Secrets (–∑–∞–º–æ—á–µ–∫ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏)")
    exit(1)

print(f"‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω: {token[:20]}...")
bot = Bot(token)
labeler = BotLabeler()

DB_PATH = "admins.db"

async def extract_user_id(text: str) -> int:
    """–ò–∑–≤–ª–µ—á—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
    if not text:
        return None

    # –ü—Ä—è–º–æ–π ID
    if text.isdigit():
        return int(text)

    # –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ [id123|text] –∏–ª–∏ @id123
    mention_match = re.search(r'\[id(\d+)\|.*?\]', text)
    if mention_match:
        return int(mention_match.group(1))

    at_match = re.search(r'@id(\d+)', text)
    if at_match:
        return int(at_match.group(1))

    # –°—Å—ã–ª–∫–∞ VK
    vk_link_match = re.search(r'vk\.com/id(\d+)', text)
    if vk_link_match:
        return int(vk_link_match.group(1))

    # –ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞ vk.com/username
    username_match = re.search(r'vk\.com/([a-zA-Z0-9_.]+)', text)
    if username_match:
        username = username_match.group(1)
        try:
            result = await bot.api.utils.resolve_screen_name(screen_name=username)
            if result and result.type == 'user':
                return result.object_id
        except:
            pass

    return None

def get_admin_level(user_id: int) -> int:
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT level FROM admins WHERE id_vk = ?", (user_id,))
        result = cursor.fetchone()
        return result[0] if result else 0

def check_command_access(user_id: int, command_name: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∫–æ–º–∞–Ω–¥–µ"""
    user_level = get_admin_level(user_id)

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT required_level, is_disabled 
            FROM command_restrictions 
            WHERE command_name = ?
        """, (command_name,))
        result = cursor.fetchone()

        if not result:
            # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é –ª–æ–≥–∏–∫—É
            return True

        required_level, is_disabled = result

        # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞
        if is_disabled:
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞
        return user_level >= required_level

async def get_user_data(user_id: int, auto_track_join=True):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id_vk = ?", (user_id,))
        result = cursor.fetchone()

        if not result:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω–æ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —á–∞—Ç–µ —á–µ—Ä–µ–∑ API
            is_really_in_chat = 0
            if current_chat_peer_id:
                try:
                    chat_members = await bot.api.messages.get_conversation_members(peer_id=current_chat_peer_id)
                    member_ids = [member.member_id for member in chat_members.items if member.member_id > 0]
                    is_really_in_chat = 1 if user_id in member_ids else 0
                except:
                    # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ API, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –≤ —á–∞—Ç–µ –µ—Å–ª–∏ –ø–∏—à–µ—Ç
                    is_really_in_chat = 1 if auto_track_join else 0

            # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                user_info = await bot.api.users.get(user_ids=[user_id])
                name = f"{user_info[0].first_name} {user_info[0].last_name}"
            except:
                name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

            if is_really_in_chat:
                cursor.execute("""
                    INSERT INTO admins (id_vk, name, level, server, domains, position, 
                                      invited_at, first_invited_at, msg_count, is_in_chat,
                                      total_time_seconds, session_start)
                    VALUES (?, ?, 0, 1, '', '', ?, ?, 1, 1, 0, ?)
                """, (user_id, name, current_time, current_time, current_time))
            else:
                cursor.execute("""
                    INSERT INTO admins (id_vk, name, level, server, domains, position, 
                                      invited_at, first_invited_at, msg_count, is_in_chat,
                                      total_time_seconds, session_start)
                    VALUES (?, ?, 0, 1, '', '', '', '', 0, 0, 0, '')
                """, (user_id, name))

            conn.commit()

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
            cursor.execute("SELECT * FROM admins WHERE id_vk = ?", (user_id,))
            return cursor.fetchone()
        else:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –∏ –æ–Ω –Ω–µ –≤ —á–∞—Ç–µ (is_in_chat = 0), –∑–Ω–∞—á–∏—Ç –æ–Ω –≤–µ—Ä–Ω—É–ª—Å—è
            if auto_track_join and len(result) > 9 and result[9] == 0:
                current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")
                cursor.execute("""
                    UPDATE admins SET invited_at = ?, is_in_chat = 1, session_start = ?
                    WHERE id_vk = ?
                """, (current_time, current_time, user_id))

                # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤–æ–æ–±—â–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º first_invited_at
                if not result[7] or result[7] == '':
                    cursor.execute("""
                        UPDATE admins SET first_invited_at = ? WHERE id_vk = ?
                    """, (current_time, user_id))

                conn.commit()

                # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                cursor.execute("SELECT * FROM admins WHERE id_vk = ?", (user_id,))
                result = cursor.fetchone()

            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ —á–∞—Ç–µ, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
            elif auto_track_join and len(result) > 11 and (not result[11] or result[11] == ''):
                current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")
                cursor.execute("""
                    UPDATE admins SET session_start = ? WHERE id_vk = ?
                """, (current_time, user_id))
                conn.commit()

                # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                cursor.execute("SELECT * FROM admins WHERE id_vk = ?", (user_id,))
                result = cursor.fetchone()

        return result

def update_message_count(user_id: int):
    """–£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE admins SET msg_count = msg_count + 1 
            WHERE id_vk = ?
        """, (user_id,))
        conn.commit()

async def send_greeting_to_user(user_id: int):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            cursor.execute("SELECT value FROM greeting_settings WHERE key = 'active_greeting_id'")
            active_greeting = cursor.fetchone()

            if not active_greeting or not active_greeting[0]:
                return  # –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è

            greeting_id = int(active_greeting[0])

            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
            cursor.execute("SELECT text, wait_seconds FROM greetings WHERE id = ?", (greeting_id,))
            greeting_data = cursor.fetchone()

            if not greeting_data:
                return  # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

            text, wait_seconds = greeting_data

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            user_info = await bot.api.users.get(user_ids=[user_id])
            user_name = f"{user_info[0].first_name} {user_info[0].last_name}"

            # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ
            formatted_text = text.replace("{name}", user_name).replace("{id}", str(user_id))

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            import asyncio
            if wait_seconds > 0:
                await asyncio.sleep(wait_seconds)

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –æ—Ç –±–æ—Ç–∞ —Å —Ç–µ–≥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            greeting_message = f"ABot ¬ª –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [id{user_id}|{user_name}]:\n\n{formatted_text}"

            await bot.api.messages.send(
                peer_id=TARGET_PEER_ID,
                message=greeting_message,
                random_id=0
            )

            print(f"‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

async def handle_user_join(user_id: int, invited_by: int = None):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –±–µ—Å–µ–¥–µ"""
    current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute("SELECT banned_at, reason, banned_by FROM blacklisted_users WHERE user_id = ?", (user_id,))
        blocked = cursor.fetchone()
        if blocked:
            print(f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ–ø—ã—Ç–∞–ª—Å—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –±–µ—Å–µ–¥–µ")

            try:
                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                user_info = await bot.api.users.get(user_ids=[user_id])
                name = f"{user_info[0].first_name} {user_info[0].last_name}"

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫—Ç–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª
                banned_by_info = await bot.api.users.get(user_ids=[blocked[2]])
                banned_by_name = f"{banned_by_info[0].first_name} {banned_by_info[0].last_name}"

                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await bot.api.messages.remove_chat_user(
                    chat_id=TARGET_CHAT_ID,
                    member_id=user_id
                )

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–µ—Å–µ–¥—É
                await bot.api.messages.send(
                    peer_id=TARGET_PEER_ID,
                    message=f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å https://vk.com/id{user_id} ({name}) –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–µ—Å–µ–¥—ã!\n\n"
                           f"üìÖ –î–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {blocked[0]}\n"
                           f"üìù –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {blocked[1]}\n"
                           f"üëÆ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª: https://vk.com/id{blocked[2]} ({banned_by_name})\n\n"
                           f"‚ÑπÔ∏è –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /unblock {user_id} <–ø—Ä–∏—á–∏–Ω–∞>",
                    random_id=0
                )

                print(f"‚úÖ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á—ë–Ω")
                return

            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
                return

        # –°–ò–°–¢–ï–ú–ê –ö–û–ù–¢–†–û–õ–Ø –ü–†–ò–ì–õ–ê–®–ï–ù–ò–ô
        if invited_by and invited_by != user_id:
            inviter_level = get_admin_level(invited_by)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ
            if inviter_level < 4:
                try:
                    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–º –∏ –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–º
                    invited_info = await bot.api.users.get(user_ids=[user_id])
                    invited_name = f"{invited_info[0].first_name} {invited_info[0].last_name}"

                    inviter_info = await bot.api.users.get(user_ids=[invited_by])
                    inviter_name = f"{inviter_info[0].first_name} {inviter_info[0].last_name}"

                    # –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await bot.api.messages.remove_chat_user(
                        chat_id=TARGET_CHAT_ID,
                        member_id=user_id
                    )

                    # –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª (–µ—Å–ª–∏ –æ–Ω –µ—â—ë –≤ –±–µ—Å–µ–¥–µ)
                    try:
                        await bot.api.messages.remove_chat_user(
                            chat_id=TARGET_CHAT_ID,
                            member_id=invited_by
                        )
                        handle_user_leave(invited_by)  # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
                    except:
                        pass  # –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π —É–∂–µ –Ω–µ –≤ –±–µ—Å–µ–¥–µ

                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–µ—Å–µ–¥—É
                    await bot.api.messages.send(
                        peer_id=TARGET_PEER_ID,
                        message=f"üö´ –ù–ê–†–£–®–ï–ù–ò–ï –ü–†–ê–í–ò–õ –ü–†–ò–ì–õ–ê–®–ï–ù–ò–Ø!\n\n"
                               f"‚ùå [https://vk.com/id{invited_by}|{inviter_name}] (—É—Ä–æ–≤–µ–Ω—å {inviter_level}) –ø–æ–ø—ã—Ç–∞–ª—Å—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
                               f"üë§ –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π: [https://vk.com/id{user_id}|{invited_name}]\n\n"
                               f"‚ö†Ô∏è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –î–ï–ô–°–¢–í–ò–Ø:\n"
                               f"üî¥ –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–∫–ª—é—á—ë–Ω\n"
                               f"üî¥ –ù–∞—Ä—É—à–∏—Ç–µ–ª—å –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–µ—Å–µ–¥—ã\n\n"
                               f"üìã –ü–†–ê–í–ò–õ–ê:\n"
                               f"‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –≤ –±–µ—Å–µ–¥—É –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —É—Ä–æ–≤–Ω—è 4 –∏ –≤—ã—à–µ\n"
                               f"‚Ä¢ –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è: {inviter_level} (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)\n"
                               f"‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å: 4",
                        random_id=0
                    )

                    print(f"üö´ –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {invited_by} (—É—Ä–æ–≤–µ–Ω—å {inviter_level}) –ø—Ä–∏–≥–ª–∞—Å–∏–ª {user_id}")
                    print(f"‚úÖ –û–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –±–µ—Å–µ–¥—ã")
                    return

                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: {e}")
                    return
        cursor.execute("SELECT * FROM admins WHERE id_vk = ?", (user_id,))
        result = cursor.fetchone()

        if result:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å –≤ –ë–î - –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞
            cursor.execute("""
                UPDATE admins SET invited_at = ?, is_in_chat = 1, session_start = ?
                WHERE id_vk = ?
            """, (current_time, current_time, user_id))

            # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º first_invited_at
            if not result[7] or result[7] == '':
                cursor.execute("""
                    UPDATE admins SET first_invited_at = ? WHERE id_vk = ?
                """, (current_time, user_id))
        else:
            # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å
            try:
                # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —á–µ—Ä–µ–∑ API (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ, –ø–æ—ç—Ç–æ–º—É —É–ø—Ä–æ—â–∞–µ–º)
                name = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}"
            except:
                name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            cursor.execute("""
                INSERT INTO admins (id_vk, name, level, server, domains, position, 
                                  invited_at, first_invited_at, msg_count, is_in_chat,
                                  total_time_seconds, session_start)
                VALUES (?, ?, 0, 1, '', '', ?, ?, 0, 1, 0, ?)
            """, (user_id, name, current_time, current_time, current_time))

        conn.commit()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await send_greeting_to_user(user_id)

def handle_user_leave(user_id: int):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–µ—Å–µ–¥—ã"""
    current_time = get_moscow_time()

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute("SELECT session_start, total_time_seconds FROM admins WHERE id_vk = ?", (user_id,))
        result = cursor.fetchone()

        if result and result[0]:
            try:
                session_start = datetime.strptime(result[0], "%Y-%m-%d %H:%M:%S")
                session_start = session_start.replace(tzinfo=MSK_TZ)
                session_duration = (current_time - session_start).total_seconds()

                new_total_time = (result[1] or 0) + session_duration

                # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –±–µ—Å–µ–¥—É
                cursor.execute("""
                    UPDATE admins SET is_in_chat = 0, total_time_seconds = ?, 
                                    invited_at = '', session_start = ''
                    WHERE id_vk = ?
                """, (new_total_time, user_id))
            except:
                # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º, –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ–∫–∏–Ω—É–≤—à–µ–≥–æ
                cursor.execute("""
                    UPDATE admins SET is_in_chat = 0, invited_at = '', session_start = ''
                    WHERE id_vk = ?
                """, (user_id,))

        conn.commit()

def calculate_time_in_chat(user_data):
    """–í—ã—á–∏—Å–ª–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –±–µ—Å–µ–¥–µ"""
    current_time = get_moscow_time()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —á–∞—Ç–µ
    is_in_chat = user_data[9] if len(user_data) > 9 else 1

    # –í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
    if is_in_chat == 1 and len(user_data) > 6 and user_data[6]:
        try:
            invited_at = datetime.strptime(user_data[6], "%Y-%m-%d %H:%M:%S")
            invited_at = invited_at.replace(tzinfo=MSK_TZ)
            delta_recent = current_time - invited_at
            days_recent = delta_recent.days
            hours_recent, remainder_recent = divmod(delta_recent.seconds, 3600)
            minutes_recent = remainder_recent // 60
            time_since_invite = f"{days_recent} –¥–Ω–µ–π {hours_recent} —á–∞—Å {minutes_recent} –º–∏–Ω—É—Ç"
        except:
            time_since_invite = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    else:
        time_since_invite = "–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"

    # –û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
    total_seconds = user_data[10] if len(user_data) > 10 else 0

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–µ–π—á–∞—Å –≤ —á–∞—Ç–µ, –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
    if is_in_chat == 1 and len(user_data) > 11 and user_data[11]:
        try:
            session_start = datetime.strptime(user_data[11], "%Y-%m-%d %H:%M:%S")
            session_start = session_start.replace(tzinfo=MSK_TZ)
            current_session = (current_time - session_start).total_seconds()

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            if is_in_chat == 1 and len(user_data) > 6 and user_data[6]:
                try:
                    invited_at = datetime.strptime(user_data[6], "%Y-%m-%d %H:%M:%S")
                    invited_at = invited_at.replace(tzinfo=MSK_TZ)
                    time_since_invite_seconds = (current_time - invited_at).total_seconds()
                    total_seconds = max(total_seconds + current_session, time_since_invite_seconds)
                except:
                    total_seconds += current_session
            else:
                total_seconds += current_session
        except:
            # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ—Å—Å–∏—é, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º—è —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            if is_in_chat == 1 and len(user_data) > 6 and user_data[6]:
                try:
                    invited_at = datetime.strptime(user_data[6], "%Y-%m-%d %H:%M:%S")
                    invited_at = invited_at.replace(tzinfo=MSK_TZ)
                    time_since_invite_seconds = (current_time - invited_at).total_seconds()
                    total_seconds = max(total_seconds, time_since_invite_seconds)
                except:
                    pass

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±—â–µ–µ –≤—Ä–µ–º—è
    if total_seconds > 0:
        total_days = int(total_seconds // 86400)
        total_hours = int((total_seconds % 86400) // 3600)
        total_minutes = int((total_seconds % 3600) // 60)
        time_total = f"{total_days} –¥–Ω–µ–π {total_hours} —á–∞—Å {total_minutes} –º–∏–Ω—É—Ç"
    else:
        time_total = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    return time_since_invite, time_total

def init_db():
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS admins (
                id_vk INTEGER PRIMARY KEY,
                name TEXT NOT NULL,
                level INTEGER NOT NULL,
                server INTEGER DEFAULT 1,
                domains TEXT DEFAULT '',
                position TEXT DEFAULT '',
                invited_at TEXT DEFAULT '',
                first_invited_at TEXT DEFAULT '',
                msg_count INTEGER DEFAULT 0,
                is_in_chat INTEGER DEFAULT 1,
                total_time_seconds REAL DEFAULT 0,
                session_start TEXT DEFAULT ''
            )
        """)

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        try:
            cursor.execute("ALTER TABLE admins ADD COLUMN first_invited_at TEXT DEFAULT ''")
        except sqlite3.OperationalError:
            pass

        try:
            cursor.execute("ALTER TABLE admins ADD COLUMN is_in_chat INTEGER DEFAULT 1")
        except sqlite3.OperationalError:
            pass

        try:
            cursor.execute("ALTER TABLE admins ADD COLUMN total_time_seconds REAL DEFAULT 0")
        except sqlite3.OperationalError:
            pass

        try:
            cursor.execute("ALTER TABLE admins ADD COLUMN session_start TEXT DEFAULT ''")
        except sqlite3.OperationalError:
            pass

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS bot_settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS domain_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                old_domain TEXT DEFAULT '',
                new_domain TEXT DEFAULT '',
                changed_by INTEGER NOT NULL,
                changed_at TEXT NOT NULL,
                FOREIGN KEY (user_id) REFERENCES admins (id_vk),
                FOREIGN KEY (changed_by) REFERENCES admins (id_vk)
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS warnings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                warns_count INTEGER DEFAULT 0,
                kicks_count INTEGER DEFAULT 0,
                FOREIGN KEY (user_id) REFERENCES admins (id_vk)
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS warning_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                action_type TEXT NOT NULL,
                warns_change INTEGER NOT NULL,
                kicks_change INTEGER DEFAULT 0,
                reason TEXT DEFAULT '',
                issued_by INTEGER NOT NULL,
                issued_at TEXT NOT NULL,
                FOREIGN KEY (user_id) REFERENCES admins (id_vk),
                FOREIGN KEY (issued_by) REFERENCES admins (id_vk)
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS blacklisted_users (
                user_id INTEGER PRIMARY KEY,
                banned_at TEXT NOT NULL,
                banned_by INTEGER NOT NULL,
                reason TEXT DEFAULT ''
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS muted_users (
                user_id INTEGER PRIMARY KEY,
                muted_at TEXT NOT NULL,
                muted_by INTEGER NOT NULL,
                muted_until TEXT DEFAULT '',
                reason TEXT DEFAULT ''
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–∞–Ω–¥–∞–º
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS command_restrictions (
                command_name TEXT PRIMARY KEY,
                required_level INTEGER NOT NULL,
                is_disabled INTEGER DEFAULT 0,
                modified_by INTEGER,
                modified_at TEXT
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS greetings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                text TEXT NOT NULL,
                wait_seconds INTEGER DEFAULT 0,
                created_by INTEGER NOT NULL,
                created_at TEXT NOT NULL,
                modified_by INTEGER,
                modified_at TEXT
            )
        """)

        # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS greeting_settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        """)

        # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        commands_with_levels = [
            ('kick', 4), ('warn', 4), ('unwarn', 4), ('warns', 4), ('warnlist', 4),
            ('mute', 4), ('unmute', 4), ('muted', 4), ('blocked', 4),
            ('addadmin', 5), ('deladmin', 5), ('setposition', 5), ('getall', 5), ('unblock', 5),
            ('dn', 3), ('admins', 3), ('top', 3),
            ('get', 1), ('help', 1), ('mywarns', 0), ('n_history', 2), ('accommand', 6),
            ('greetings', 6), ('ban', 6)
        ]

        for cmd, level in commands_with_levels:
            cursor.execute("""
                INSERT OR IGNORE INTO command_restrictions (command_name, required_level)
                VALUES (?, ?)
            """, (cmd, level))

        conn.commit()

async def one_time_reset_chat_users():
    """–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–µ—Å–µ–¥–µ"""
    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞
            cursor.execute("SELECT value FROM bot_settings WHERE key = 'chat_time_reset_done'")
            result = cursor.fetchone()
            if result and result[0] == '1':
                print("üîÑ –°–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã —É–∂–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω")
                return

            current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

            # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –±–µ—Å–µ–¥–µ (is_in_chat = 1)
            cursor.execute("SELECT id_vk FROM admins WHERE is_in_chat = 1")
            chat_users = cursor.fetchall()

            updated_count = 0
            for (user_id,) in chat_users:
                cursor.execute("""
                    UPDATE admins SET 
                        invited_at = ?,
                        first_invited_at = CASE 
                            WHEN first_invited_at IS NULL OR first_invited_at = '' THEN ?
                            ELSE first_invited_at
                        END,
                        session_start = ?,
                        total_time_seconds = 0
                    WHERE id_vk = ? AND is_in_chat = 1
                """, (current_time, current_time, current_time, user_id))
                updated_count += 1

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ —Å–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á)
            cursor.execute("""
                INSERT OR REPLACE INTO bot_settings (key, value) VALUES ('chat_time_reset_done', '1')
            """)

            conn.commit()
            print(f"üîÑ –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è {updated_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã")

    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã: {e}")

# –¶–µ–ª–µ–≤–∞—è –±–µ—Å–µ–¥–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—ã–π ID)
TARGET_CHAT_ID = 2  # ID –±–µ—Å–µ–¥—ã (peer_id –±—É–¥–µ—Ç 2000000001)
TARGET_PEER_ID = 2000000000 + TARGET_CHAT_ID

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è peer_id –±–µ—Å–µ–¥—ã
current_chat_peer_id = None

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
user_last_n_history = {}

# –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–ª—É—á–∏–≤—à–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –º—É—Ç–µ
mute_notifications_sent = set()

async def sync_chat_members():
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã —Å –ë–î —á–µ—Ä–µ–∑ VK API"""
    global current_chat_peer_id

    try:
        if not current_chat_peer_id:
            print("‚ö†Ô∏è –ï—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –±–µ—Å–µ–¥—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ID")
            print("üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è")
            return

        try:
            chat_members = await bot.api.messages.get_conversation_members(peer_id=current_chat_peer_id)
            current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

            with sqlite3.connect(DB_PATH) as conn:
                cursor = conn.cursor()

                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î
                cursor.execute("SELECT id_vk FROM admins")
                db_users = set([row[0] for row in cursor.fetchall()])

                # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã
                active_members = set()
                for member in chat_members.items:
                    if member.member_id > 0:  # –ò—Å–∫–ª—é—á–∞–µ–º –±–æ—Ç—ã
                        active_members.add(member.member_id)

                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                for user_id in db_users:
                    if user_id in active_members:
                        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —á–∞—Ç–µ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                        cursor.execute("""
                            UPDATE admins SET is_in_chat = 1 WHERE id_vk = ?
                        """, (user_id,))
                    else:
                        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ —á–∞—Ç–µ - –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ–∫–∏–Ω—É–≤—à–µ–≥–æ
                        cursor.execute("""
                            UPDATE admins SET is_in_chat = 0 WHERE id_vk = ?
                        """, (user_id,))

                conn.commit()
                chat_id = current_chat_peer_id - 2000000000
                print(f"‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –±–µ—Å–µ–¥—ã ID {chat_id}: –Ω–∞–π–¥–µ–Ω–æ {len(active_members)} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤")

        except Exception as api_error:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ API: {api_error}")
            print("üîÑ –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º")

    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {e}")

async def auto_track_member_changes(message: Message):
    """–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è VK"""
    if hasattr(message, 'action') and message.action is not None:
        current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

        if message.action.type == 'chat_invite_user':
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≥–ª–∞—à—ë–Ω
            invited_user_id = message.action.member_id
            inviter_id = message.from_id  # –ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
            await handle_user_join(invited_user_id, inviter_id)
            print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {invited_user_id} –ø—Ä–∏–≥–ª–∞—à—ë–Ω –≤ –±–µ—Å–µ–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {inviter_id}")

        elif message.action.type == 'chat_kick_user':
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–∫–ª—é—á—ë–Ω
            kicked_user_id = message.action.member_id
            handle_user_leave(kicked_user_id)
            print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {kicked_user_id} –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–µ—Å–µ–¥—ã")

@labeler.message(text="/kick <user_arg> <reason>")
async def kick_user_with_reason(message: Message, user_arg: str, reason: str):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ü–µ–ª–µ–≤—É—é –±–µ—Å–µ–¥—É
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'kick'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    user_level = get_admin_level(message.from_id)

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n"
            "/kick <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
            "/kick <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
            "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK"
        )

    target_level = get_admin_level(id_vk)
    if target_level >= user_level:
        return await message.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ.")

    try:
        await bot.api.messages.remove_chat_user(
            chat_id=message.peer_id - 2000000000,
            member_id=id_vk
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
        handle_user_leave(id_vk)

        try:
            user_info = await bot.api.users.get(user_ids=[id_vk])
            name = f"{user_info[0].first_name} {user_info[0].last_name}"
        except:
            name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        await message.answer(f"‚úÖ [https://vk.com/id{id_vk}|{name}] –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–µ—Å–µ–¥—ã.\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}")
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏: {str(e)}")

@labeler.message(text="/kick <user_arg>")
async def kick_user_no_reason(message: Message, user_arg: str):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ü–µ–ª–µ–≤—É—é –±–µ—Å–µ–¥—É
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'kick'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    user_level = get_admin_level(message.from_id)

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n"
            "/kick <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
            "/kick <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
            "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK"
        )

    target_level = get_admin_level(id_vk)
    if target_level >= user_level:
        return await message.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ.")

    try:
        await bot.api.messages.remove_chat_user(
            chat_id=message.peer_id - 2000000000,
            member_id=id_vk
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
        handle_user_leave(id_vk)

        try:
            user_info = await bot.api.users.get(user_ids=[id_vk])
            name = f"{user_info[0].first_name} {user_info[0].last_name}"
        except:
            name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        await message.answer(f"‚úÖ [https://vk.com/id{id_vk}|{name}] –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–µ—Å–µ–¥—ã.\nüìù –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞")
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏: {str(e)}")

@labeler.message(text="/kick")
async def kick_help(message: Message):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ü–µ–ª–µ–≤—É—é –±–µ—Å–µ–¥—É
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'kick'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n\n"
        "/kick <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
        "/kick <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/kick @id123456789\n"
        "/kick 123456789 –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª\n"
        "/kick https://vk.com/id123456789 –°–ø–∞–º"
    )

@labeler.message(text="/admins <page:int>")
async def admins_list(message: Message, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'admins'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT id_vk, name, level FROM admins WHERE level > 0 ORDER BY level DESC")
        admins = cursor.fetchall()

    per_page = 10
    total_pages = (len(admins) + per_page - 1) // per_page
    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –¢–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ—Ç. –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}.")

    start = (page - 1) * per_page
    admins_slice = admins[start:start + per_page]
    text = f"ABot ¬ª –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤. –°—Ç—Ä–∞–Ω–∏—Ü–∞: {page}/{total_pages}\n\n"
    for i, (uid, name, level) in enumerate(admins_slice, start=start + 1):
        text += f"{i}. [https://vk.com/id{uid}|{name}] (ID: {uid}), —É—Ä–æ–≤–µ–Ω—å: {level}\n"

    await message.answer(text)

@labeler.message(text="/admins")
async def admins_missing_page(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'admins'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
    else:
        return await message.answer("‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ü—Ä–∏–º–µ—Ä: /admins 1")

@labeler.message(text="/addadmin <user_arg> <level:int>")
async def add_admin(message: Message, user_arg: str, level: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 5:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    if level >= user_level:
        return await message.answer(f"‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞ —Å —É—Ä–æ–≤–Ω–µ–º {level} ‚Äî –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∂–µ –≤–∞—à–µ–≥–æ ({user_level}).")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute("SELECT banned_at, reason FROM blacklisted_users WHERE user_id = ?", (id_vk,))
        blocked = cursor.fetchone()
        if blocked:
            try:
                user_info = await bot.api.users.get(user_ids=[id_vk])
                name = f"{user_info[0].first_name} {user_info[0].last_name}"
            except:
                name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            return await message.answer(f"üö´ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ [https://vk.com/id{id_vk}|{name}] - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n"
                                       f"üìÖ –î–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {blocked[0]}\n"
                                       f"üìù –ü—Ä–∏—á–∏–Ω–∞: {blocked[1]}\n\n"
                                       f"üí° –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: /unblock {id_vk} <–ø—Ä–∏—á–∏–Ω–∞>")

        cursor.execute("SELECT level FROM admins WHERE id_vk = ?", (id_vk,))
        existing = cursor.fetchone()

        if existing and existing[0] > 0:
            return await message.answer("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω.")

        try:
            user = (await bot.api.users.get(user_ids=[id_vk]))[0]
            name = f"{user.first_name} {user.last_name}"
        except Exception:
            name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

        if existing:
            # –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∫–∏ –ù–ï —Ç—Ä–æ–≥–∞–µ–º invited_at - –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –±–µ—Å–µ–¥—É
            cursor.execute("""
                UPDATE admins SET level = ?, name = ?
                WHERE id_vk = ?
            """, (level, name, id_vk))
        else:
            # –î–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∫–∞–∫ –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏
            cursor.execute("""
                INSERT INTO admins (id_vk, name, level, invited_at, first_invited_at)
                VALUES (?, ?, ?, ?, ?)
            """, (id_vk, name, level, current_time, current_time))

        conn.commit()

    await message.answer(f"‚úÖ [https://vk.com/id{id_vk}|{name}] –¥–æ–±–∞–≤–ª–µ–Ω —Å —É—Ä–æ–≤–Ω–µ–º {level}.")

@labeler.message(text="/deladmin <user_arg>")
async def del_admin(message: Message, user_arg: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 5:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —É–¥–∞–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT name, level FROM admins WHERE id_vk = ?", (id_vk,))
        row = cursor.fetchone()
        if not row:
            return await message.answer("‚ö†Ô∏è –ê–¥–º–∏–Ω —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        target_name, target_level = row

        if target_level >= user_level:
            return await message.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤ —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ.")

        cursor.execute("UPDATE admins SET level = 0 WHERE id_vk = ?", (id_vk,))
        conn.commit()

    await message.answer(f"üóëÔ∏è [https://vk.com/id{id_vk}|{target_name}] —É–¥–∞–ª—ë–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤."), 

@labeler.message(text="/get <user_arg>")
@labeler.message(text="/get")
async def get_user_info(message: Message, user_arg: str = None):
    if message.peer_id != TARGET_PEER_ID:
        return

    requester_level = get_admin_level(message.from_id)

    if user_arg:
        target_id = await extract_user_id(user_arg)
        if not target_id:
            return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")
    else:
        target_id = message.from_id

    if target_id != message.from_id and requester_level < 2:
        return await message.answer("‚õî –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –æ —Å–µ–±–µ.")

    try:
        user = (await bot.api.users.get(user_ids=[target_id]))[0]
        full_name = f"{user.first_name} {user.last_name}"
    except Exception:
        full_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    user_data = await get_user_data(target_id, auto_track_join=False)

    if len(user_data) >= 12:
        (uid, name, level, server, domains, position, 
         invited_at_str, first_invited_at_str, msg_count, is_in_chat, 
         total_time_seconds, session_start) = user_data[:12]
    else:
        # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
        uid, name, level, server = user_data[:4]
        domains = user_data[4] if len(user_data) > 4 else ''
        position = user_data[5] if len(user_data) > 5 else ''
        invited_at_str = user_data[6] if len(user_data) > 6 else ''
        first_invited_at_str = user_data[7] if len(user_data) > 7 else ''
        msg_count = user_data[8] if len(user_data) > 8 else 0
        is_in_chat = 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –≤ —á–∞—Ç–µ
        total_time_seconds = 0
        session_start = ''

    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è
    time_since_invite, time_total = calculate_time_in_chat(user_data)

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
    if invited_at_str and invited_at_str != '' and is_in_chat:
        try:
            invited_at_dt = datetime.strptime(invited_at_str, "%Y-%m-%d %H:%M:%S")
            invited_at_display = invited_at_dt.strftime("%d.%m.%Y %H:%M")
        except:
            invited_at_display = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    else:
        invited_at_display = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    chat_name = "RADMIR [–ú–û][–ö–∞—Ä–∞—Ç–µ–ª–∏][SERVER 01]"
    level_text = f"{level}" if level > 0 else "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–æ–º–µ–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
    if domains:
        domains_list = [d.strip() for d in domains.split(',') if d.strip()]
        domains_text = ', '.join(domains_list) if domains_list else "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
    else:
        domains_text = "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

    position_text = position if position else "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

    text = (
        f"ABot ¬ª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ [https://vk.com/id{target_id}|{full_name}]\n\n"
        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ—Å–µ–¥–µ:\n"
        f" ‚Äì \"{chat_name}\"\n"
        f" ‚Äì –ü—Ä–∏–≥–ª–∞—à–µ–Ω –≤ –±–µ—Å–µ–¥—É: {invited_at_display}\n\n"
        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö:\n"
        f" ‚Äì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {msg_count}\n\n"
        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n"
        f" ‚Äì –°–µ—Ä–≤–µ—Ä: {server}\n"
        f" ‚Äì –î–æ–º–µ–Ω—ã: {domains_text}\n"
        f" ‚Äì –£—Ä–æ–≤–µ–Ω—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {level_text}\n"
        f" ‚Äì –î–æ–ª–∂–Ω–æ—Å—Ç—å: {position_text}\n\n"
        f"–í—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –±–µ—Å–µ–¥–µ:\n"
        f" ‚Äì –° –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: {time_since_invite}\n"
        f" ‚Äì –ó–∞ –≤—Å—ë –≤—Ä–µ–º—è: {time_total}"
    )

    await message.answer(text)



@labeler.message(text="/setposition <user_arg> <position>")
async def set_position(message: Message, user_arg: str, position: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 5:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º–∏.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    await get_user_data(id_vk, auto_track_join=False)

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("UPDATE admins SET position = ? WHERE id_vk = ?", (position, id_vk))
        cursor.execute("SELECT name FROM admins WHERE id_vk = ?", (id_vk,))
        result = cursor.fetchone()
        name = result[0] if result else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        conn.commit()

    await message.answer(f"‚úÖ –î–æ–ª–∂–Ω–æ—Å—Ç—å –¥–ª—è [https://vk.com/id{id_vk}|{name}] —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {position}")

@labeler.message(text="/help <level:int>")
async def help_level(message: Message, level: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level == 0:
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    if level < 0 or level > 6:
        return await message.answer("‚ùå –£—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 6.")

    if level > user_level:
        return await message.answer(f"‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã —É—Ä–æ–≤–Ω—è {level}, –¥–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.")

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–∞–Ω–¥–∞–º –∏–∑ –ë–î
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT command_name, required_level, is_disabled FROM command_restrictions")
        command_restrictions = {row[0]: (row[1], row[2]) for row in cursor.fetchall()}

    def get_commands_for_level(target_level):
        commands = []
        for cmd_name, (required_level, is_disabled) in command_restrictions.items():
            if required_level == target_level and not is_disabled:
                commands.append(f"‚Ä¢ /{cmd_name}")
        return commands

    commands_for_level = get_commands_for_level(level)

    if commands_for_level:
        commands_text = '\n'.join(commands_for_level)
        text = f"ABot ¬ª –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—É—Ä–æ–≤–µ–Ω—å {level}):\n{commands_text}"
        if level < 6:
            text += "\n‚Ä¢ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É—Ä–æ–≤–Ω–µ–π"
    else:
        text = f"ABot ¬ª –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—É—Ä–æ–≤–µ–Ω—å {level}):\n‚Ä¢ –ù–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è"
        if level > 0:
            text += "\n‚Ä¢ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É—Ä–æ–≤–Ω–µ–π"

    await message.answer(text)

@labeler.message(text="/help")
async def help_usage(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'help'):
        return

    user_level = get_admin_level(message.from_id)

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    try:
        user_info = await bot.api.users.get(user_ids=[message.from_id])
        user_name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        user_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    if user_level == 0:
        return await message.answer(f"‚õî [https://vk.com/id{message.from_id}|{user_name}], —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.\n\nüîπ –í–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {user_level} (–£—á–∞—Å—Ç–Ω–∏–∫)")

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–∞–Ω–¥–∞–º –∏–∑ –ë–î
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT command_name, required_level, is_disabled FROM command_restrictions")
        command_restrictions = {row[0]: (row[1], row[2]) for row in cursor.fetchall()}

    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ —Å –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∏ —Ç—Ä–µ–±—É–µ–º—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏
    command_descriptions = {
        'accommand': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–º–∞–Ω–¥–∞–º',
        'greetings': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏', 
        'ban': '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        'addadmin': '–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
        'deladmin': '–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
        'setposition': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º–∏',
        'getall': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö',
        'unblock': '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        'kick': '–ò—Å–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        'warn': '–í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
        'unwarn': '–°–Ω—è—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
        'warns': '–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏',
        'warnlist': '–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        'mute': '–ó–∞–≥–ª—É—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        'unmute': '–°–Ω—è—Ç—å –∑–∞–≥–ª—É—à–∫—É',
        'muted': '–°–ø–∏—Å–æ–∫ –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        'blocked': '–°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        'dn': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        'admins': '–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤',
        'top': '–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º',
        'get': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ',
        'n_history': '–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤',
        'help': '–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º',
        'mywarns': '–í–∞—à–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è'
    }

    # –°–æ–±–∏—Ä–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É—Ä–æ–≤–Ω—è
    available_commands = []

    for cmd_name, description in command_descriptions.items():
        if cmd_name in command_restrictions:
            required_level, is_disabled = command_restrictions[cmd_name]
            if not is_disabled and user_level >= required_level:
                available_commands.append((required_level, cmd_name, description))

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É—Ä–æ–≤–Ω—è (—Å–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ –≤—ã—Å–æ–∫–∏–µ)
    available_commands.sort(reverse=True)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
    commands_list = []
    for required_level, cmd_name, description in available_commands:
        level_suffix = f" ({required_level}+ —É—Ä–æ–≤–µ–Ω—å)" if required_level > 0 else ""
        commands_list.append(f"‚Ä¢ /{cmd_name} - {description}{level_suffix}")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    commands_text = '\n'.join(commands_list) if commands_list else "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥"

    text = (
        f"ABot ¬ª –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –¥–ª—è [https://vk.com/id{message.from_id}|{user_name}]\n\n"
        f"üîπ –í–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {user_level}\n\n"
        f"üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n"
        f"{commands_text}\n\n"
        f"üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:\n"
        f"‚Ä¢ /help <1-6> - –∫–æ–º–∞–Ω–¥—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è\n"
        f"‚Ä¢ –î–ª—è –≤—ã–¥–∞—á–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: 2 –ø—Ä–µ–¥. = 1 –≤—ã–≥–æ–≤–æ—Ä"
    )

    await message.answer(text)

@labeler.message(text="/n_history <user_arg> <page:int>")
async def domain_history_with_page(message: Message, user_arg: str, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'n_history'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    user_last_n_history[message.from_id] = {'target_id': id_vk, 'page': page}

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        full_name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        full_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT old_domain, new_domain, changed_by, changed_at 
            FROM domain_history 
            WHERE user_id = ? 
            ORDER BY id DESC
        """, (id_vk,))
        history = cursor.fetchall()

    if not history:
        return await message.answer("üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è [https://vk.com/id{id_vk}|{full_name}] –ø—É—Å—Ç–∞.")

    per_page = 10
    total_pages = (len(history) + per_page - 1) // per_page

    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}")

    start = (page - 1) * per_page
    history_slice = history[start:start + per_page]

    text = f"ABot ¬ª –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {full_name} (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}):\n\n"

    for old_domain, new_domain, changed_by, changed_at in history_slice:
        old_text = f"'{old_domain}'" if old_domain else "''"
        new_text = f"'{new_domain}'" if new_domain else "''"

        try:
            changer_info = await bot.api.users.get(user_ids=[changed_by])
            changer_name = f"{changer_info[0].first_name} {changer_info[0].last_name}"
        except:
            changer_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        text += f"[{changed_at}] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏: {old_text} ‚Üí {new_text} (–∏–∑–º–µ–Ω–∏–ª [https://vk.com/id{changed_by}|{changer_name}])\n"

    await message.answer(text)

@labeler.message(text="/n_history <user_arg>")
async def domain_history_no_page(message: Message, user_arg: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'n_history'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    user_last_n_history[message.from_id] = {'target_id': id_vk, 'page': 1}

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        full_name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        full_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT old_domain, new_domain, changed_by, changed_at 
            FROM domain_history 
            WHERE user_id = ? 
            ORDER BY id DESC
        """, (id_vk,))
        history = cursor.fetchall()

    if not history:
        return await message.answer("üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è [https://vk.com/id{id_vk}|{full_name}] –ø—É—Å—Ç–∞.")

    per_page = 10
    total_pages = (len(history) + per_page - 1) // per_page

    history_slice = history[:per_page]

    text = f"ABot ¬ª –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {full_name} (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1/{total_pages}):\n\n"

    for old_domain, new_domain, changed_by, changed_at in history_slice:
        old_text = f"'{old_domain}'" if old_domain else "''"
        new_text = f"'{new_domain}'" if new_domain else "''"

        try:
            changer_info = await bot.api.users.get(user_ids=[changed_by])
            changer_name = f"{changer_info[0].first_name} {changer_info[0].last_name}"
        except:
            changer_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        text += f"[{changed_at}] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏: {old_text} ‚Üí {new_text} (–∏–∑–º–µ–Ω–∏–ª [https://vk.com/id{changed_by}|{changer_name}])\n"

    await message.answer(text)

@labeler.message(text="/n_history")
async def n_history_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'n_history'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /n_history:\n\n"
        "/n_history <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
        "/n_history <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–°—Ç—Ä–∞–Ω–∏—Ü–∞>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/n_history @id123456789\n"
        "/n_history 123456789 2\n"
        "/n_history https://vk.com/id123456789"
    )

@labeler.message(text="/addadmin <user_arg>")
async def addadmin_help(message: Message, user_arg: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'addadmin'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /addadmin:\n\n"
        "/addadmin <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–£—Ä–æ–≤–µ–Ω—å>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/addadmin @id123456789 3\n"
        "/addadmin 123456789 4\n"
        "/addadmin https://vk.com/id123456789 2"
    )

@labeler.message(text="/addadmin")
async def addadmin_missing_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'addadmin'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /addadmin:\n\n"
        "/addadmin <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–£—Ä–æ–≤–µ–Ω—å>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/addadmin @id123456789 3\n"
        "/addadmin 123456789 4\n"
        "/addadmin https://vk.com/id123456789 2"
    )

@labeler.message(text="/deladmin")
async def deladmin_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'deladmin'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /deladmin:\n\n"
        "/deladmin <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/deladmin @id123456789\n"
        "/deladmin 123456789\n"
        "/deladmin https://vk.com/id123456789"
    )



@labeler.message(text="/setposition <user_arg>")
async def setposition_help(message: Message, user_arg: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'setposition'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /setposition:\n\n"
        "/setposition <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–î–æ–ª–∂–Ω–æ—Å—Ç—å>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/setposition @id123456789 –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\n"
        "/setposition 123456789 –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä\n"
        "/setposition https://vk.com/id123456789 –°—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω"
    )

@labeler.message(text="/setposition")
async def setposition_missing_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'setposition'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /setposition:\n\n"
        "/setposition <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–î–æ–ª–∂–Ω–æ—Å—Ç—å>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/setposition @id123456789 –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\n"
        "/setposition 123456789 –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä\n"
        "/setposition https://vk.com/id123456789 –°—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω"
    )

@labeler.message(text="/dn consist_list")
async def dn_consist_list(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'dn'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT id_vk, name, domains FROM admins WHERE domains != '' ORDER BY name")
        users_with_domains = cursor.fetchall()

    if not users_with_domains:
        return await message.answer("üìù –°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ –ø—É—Å—Ç.")

    text = "ABot ¬ª –°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏:\n\n"
    for uid, name, domains in users_with_domains:
        domains_list = [d.strip() for d in domains.split(',') if d.strip()]
        domains_text = ', '.join(domains_list)
        text += f"[https://vk.com/id{uid}|{name}]: {domains_text}\n"

    await message.answer(text)

@labeler.message(text="/dn add <user_arg> <domain>")
async def dn_add(message: Message, user_arg: str, domain: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 3:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–º–µ–Ω–∞–º–∏.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    await get_user_data(id_vk, auto_track_join=False)

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–æ–º–µ–Ω—ã –∏ –∏–º—è
        cursor.execute("SELECT domains, name FROM admins WHERE id_vk = ?", (id_vk,))
        result = cursor.fetchone()
        old_domains = result[0] if result and result[0] else ''
        name = result[1] if result else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
        if old_domains:
            domains_list = [d.strip() for d in old_domains.split(',') if d.strip()]
            if domain not in domains_list:
                domains_list.append(domain)
                new_domains = ', '.join(domains_list)
            else:
                return await message.answer(f"‚ö†Ô∏è –î–æ–º–µ–Ω '{domain}' —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è [https://vk.com/id{id_vk}|{name}]")
        else:
            new_domains = domain

        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–º–µ–Ω—ã
        cursor.execute("UPDATE admins SET domains = ? WHERE id_vk = ?", (new_domains, id_vk))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")
        cursor.execute("""
            INSERT INTO domain_history (user_id, old_domain, new_domain, changed_by, changed_at)
            VALUES (?, ?, ?, ?, ?)
        """, (id_vk, old_domains, new_domains, message.from_id, current_time))

        conn.commit()

    await message.answer(f"‚úÖ –î–æ–º–µ–Ω '{domain}' –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è [https://vk.com/id{id_vk}|{name}]")

@labeler.message(text="/dn set <user_arg> <domain>")
async def dn_set(message: Message, user_arg: str, domain: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 3:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–º–µ–Ω–∞–º–∏.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    await get_user_data(id_vk, auto_track_join=False)

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–æ–º–µ–Ω—ã
        cursor.execute("SELECT domains, name FROM admins WHERE id_vk = ?", (id_vk,))
        result = cursor.fetchone()
        old_domains = result[0] if result and result[0] else ''
        name = result[1] if result else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–æ–º–µ–Ω (–∑–∞–º–µ–Ω—è–µ–º –≤—Å–µ)
        cursor.execute("UPDATE admins SET domains = ? WHERE id_vk = ?", (domain, id_vk))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")
        cursor.execute("""
            INSERT INTO domain_history (user_id, old_domain, new_domain, changed_by, changed_at)
            VALUES (?, ?, ?, ?, ?)
        """, (id_vk, old_domains, domain, message.from_id, current_time))

        conn.commit()

    await message.answer(f"‚úÖ –î–æ–º–µ–Ω –¥–ª—è [https://vk.com/id{id_vk}|{name}] —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {domain}")

@labeler.message(text="/dn del <user_arg> <domain>")
async def dn_del(message: Message, user_arg: str, domain: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 3:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–º–µ–Ω–∞–º–∏.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–æ–º–µ–Ω—ã
        cursor.execute("SELECT domains, name FROM admins WHERE id_vk = ?", (id_vk,))
        result = cursor.fetchone()
        if not result:
            return await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")

        old_domains = result[0] if result[0] else ''
        name = result[1]

        if not old_domains:
            return await message.answer(f"‚ùå –£ [https://vk.com/id{id_vk}|{name}] –Ω–µ—Ç –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")

        # –£–¥–∞–ª—è–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–æ–º–µ–Ω
        domains_list = [d.strip() for d in old_domains.split(',') if d.strip()]
        if domain not in domains_list:
            return await message.answer(f"‚ùå –î–æ–º–µ–Ω '{domain}' –Ω–µ –Ω–∞–π–¥–µ–Ω —É [https://vk.com/id{id_vk}|{name}]")

        domains_list.remove(domain)
        new_domains = ', '.join(domains_list) if domains_list else ''

        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–º–µ–Ω—ã
        cursor.execute("UPDATE admins SET domains = ? WHERE id_vk = ?", (new_domains, id_vk))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")
        cursor.execute("""
            INSERT INTO domain_history (user_id, old_domain, new_domain, changed_by, changed_at)
            VALUES (?, ?, ?, ?, ?)
        """, (id_vk, old_domains, new_domains, message.from_id, current_time))

        conn.commit()

    await message.answer(f"‚úÖ –î–æ–º–µ–Ω '{domain}' —É–¥–∞–ª—ë–Ω —É [https://vk.com/id{id_vk}|{name}]")

@labeler.message(text="/dn clear <user_arg>")
async def dn_clear(message: Message, user_arg: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 3:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–º–µ–Ω–∞–º–∏.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID, @—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫—É VK.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–æ–º–µ–Ω—ã
        cursor.execute("SELECT domains, name FROM admins WHERE id_vk = ?", (id_vk,))
        result = cursor.fetchone()
        if not result:
            return await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")

        old_domains = result[0] if result[0] else ''
        name = result[1]

        if not old_domains:
            return await message.answer(f"‚ùå –£ [https://vk.com/id{id_vk}|{name}] –Ω–µ—Ç –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")

        # –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–æ–º–µ–Ω—ã
        cursor.execute("UPDATE admins SET domains = '' WHERE id_vk = ?", (id_vk,))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")
        cursor.execute("""
            INSERT INTO domain_history (user_id, old_domain, new_domain, changed_by, changed_at)
            VALUES (?, ?, ?, ?, ?)
        """, (id_vk, old_domains, '', message.from_id, current_time))

        conn.commit()

    await message.answer(f"‚úÖ –í—Å–µ –¥–æ–º–µ–Ω—ã —É–¥–∞–ª–µ–Ω—ã —É [https://vk.com/id{id_vk}|{name}]")

@labeler.message(text="/dn get <domain>")
async def dn_get(message: Message, domain: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 3:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT id_vk, name, domains FROM admins WHERE domains LIKE ?", (f'%{domain}%',))
        users = cursor.fetchall()

    matching_users = []
    for uid, name, domains in users:
        domains_list = [d.strip() for d in domains.split(',') if d.strip()]
        if domain in domains_list:
            matching_users.append((uid, name))

    if not matching_users:
        return await message.answer(f"‚ùå –î–æ–º–µ–Ω '{domain}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏.")

    text = f"ABot ¬ª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω—É '{domain}':\n\n"
    for uid, name in matching_users:
        text += f"[https://vk.com/id{uid}|{name}] (ID: {uid})\n"

    await message.answer(text)

@labeler.message(text="/dn")
async def dn_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    user_level = get_admin_level(message.from_id)
    if user_level < 3:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "ABot ¬ª –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n\n"
        "/dn <–ê—Ä–≥—É–º–µ–Ω—Ç>\n"
        "/dn <–ê—Ä–≥—É–º–µ–Ω—Ç> <–î–æ–º–µ–Ω>\n"
        "/dn <–ê—Ä–≥—É–º–µ–Ω—Ç> <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
        "/dn <–ê—Ä–≥—É–º–µ–Ω—Ç> <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–î–æ–º–µ–Ω>\n\n"
        "–°–ø–∏—Å–æ–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤:\n"
        "‚Äî 'consist_list' - —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏\n"
        "‚Äî 'add' - –≤—ã–¥–∞—Ç—å –¥–æ–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏\n"
        "‚Äî 'set' - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\n"
        "‚Äî 'del' - —É–¥–∞–ª–∏—Ç—å –¥–æ–º–µ–Ω –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏\n"
        "‚Äî 'clear' - —É–¥–∞–ª–∏—Ç—å –¥–æ–º–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏\n"
        "‚Äî 'get' - —É–∑–Ω–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –¥–æ–º–µ–Ω—É –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏"
    )

@labeler.message(text="/getall")
async def get_all_users(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return

    user_level = get_admin_level(message.from_id)
    if user_level < 5:
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE is_in_chat = 1 ORDER BY level DESC, name")
        all_users = cursor.fetchall()

    if not all_users:
        return await message.answer("üìù –í –±–µ—Å–µ–¥–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    text = "ABot ¬ª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏:\n\n"

    for user_data in all_users:
        if len(user_data) >= 12:
            (uid, name, level, server, domains, position, 
             invited_at_str, first_invited_at_str, msg_count, is_in_chat, 
             total_time_seconds, session_start) = user_data[:12]
        else:
            # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
            uid, name, level, server = user_data[:4]
            domains = user_data[4] if len(user_data) > 4 else ''
            position = user_data[5] if len(user_data) > 5 else ''
            invited_at_str = user_data[6] if len(user_data) > 6 else ''
            first_invited_at_str = user_data[7] if len(user_data) > 7 else ''
            msg_count = user_data[8] if len(user_data) > 8 else 0
            is_in_chat = 1
            total_time_seconds = 0
            session_start = ''

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        level_text = f"{level}" if level > 0 else "0"

        if domains:
            domains_list = [d.strip() for d in domains.split(',') if d.strip()]
            domains_text = ', '.join(domains_list) if domains_list else "–Ω–µ—Ç"
        else:
            domains_text = "–Ω–µ—Ç"

        position_text = position if position else "–Ω–µ—Ç"
        status_text = "–≤ —á–∞—Ç–µ" if is_in_chat else "–Ω–µ –≤ —á–∞—Ç–µ"

        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        if invited_at_str and invited_at_str != '' and is_in_chat:
            try:
                invited_at_dt = datetime.strptime(invited_at_str, "%Y-%m-%d %H:%M:%S")
                invited_at_display = invited_at_dt.strftime("%d.%m.%Y %H:%M")
            except:
                invited_at_display = "–æ—à–∏–±–∫–∞"
        else:
            invited_at_display = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

        text += f"üë§ [https://vk.com/id{uid}|{name}]\n"
        text += f"   –£—Ä–æ–≤–µ–Ω—å: {level_text} | –°–µ—Ä–≤–µ—Ä: {server} | –°—Ç–∞—Ç—É—Å: {status_text}\n"
        text += f"   –î–æ–º–µ–Ω—ã: {domains_text}\n"
        text += f"   –î–æ–ª–∂–Ω–æ—Å—Ç—å: {position_text}\n"
        text += f"   –°–æ–æ–±—â–µ–Ω–∏–π: {msg_count} | –ü—Ä–∏–≥–ª–∞—à—ë–Ω: {invited_at_display}\n\n"

    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
    max_length = 4000
    if len(text) > max_length:
        parts = []
        current_part = ""
        lines = text.split('\n')

        for line in lines:
            if len(current_part) + len(line) + 1 > max_length:
                if current_part:
                    parts.append(current_part)
                current_part = line
            else:
                current_part += '\n' + line if current_part else line

        if current_part:
            parts.append(current_part)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ —á–∞—Å—Ç—è–º
        for i, part in enumerate(parts, 1):
            part_header = f"ABot ¬ª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö (—á–∞—Å—Ç—å {i}/{len(parts)}):\n\n"
            await message.answer(part_header + part.split('\n\n', 1)[1] if i > 1 else part)
    else:
        await message.answer(text)

@labeler.message(text="/warn <user_arg> <warns_count:int> <reason>")
async def warn_user_with_reason(message: Message, user_arg: str, warns_count: int, reason: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'warn'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
    user_level = get_admin_level(message.from_id)

    if warns_count <= 0:
        return await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/warn <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ö–æ–ª-–≤–æ –ø—Ä–µ–¥.> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/warn @id123456789 1 –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª"
        )

    target_level = get_admin_level(id_vk)
    if target_level >= user_level:
        return await message.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ.")

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    await get_user_data(id_vk, auto_track_join=False)

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        cursor.execute("SELECT warns_count, kicks_count FROM warnings WHERE user_id = ?", (id_vk,))
        result = cursor.fetchone()

        if result:
            old_warns, old_kicks = result
            new_warns = old_warns + warns_count
            new_kicks = old_kicks
        else:
            old_warns, old_kicks = 0, 0
            new_warns = warns_count
            new_kicks = 0
            # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
            cursor.execute("INSERT INTO warnings (user_id, warns_count, kicks_count) VALUES (?, 0, 0)", (id_vk,))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (2 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è = 1 –≤—ã–≥–æ–≤–æ—Ä)
        if new_warns >= 2:
            kicks_to_add = new_warns // 2
            new_kicks += kicks_to_add
            new_warns = new_warns % 2

            # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            cursor.execute("UPDATE warnings SET warns_count = ?, kicks_count = ? WHERE user_id = ?", 
                         (new_warns, new_kicks, id_vk))

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            cursor.execute("""
                INSERT INTO warning_history (user_id, action_type, warns_change, kicks_change, reason, issued_by, issued_at)
                VALUES (?, 'warn', ?, ?, ?, ?, ?)
            """, (id_vk, warns_count, kicks_to_add, reason, message.from_id, current_time))

            conn.commit()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–∏–∫ –ø—Ä–∏ 3 –≤—ã–≥–æ–≤–æ—Ä–∞—Ö
            if new_kicks >= 3:
                try:
                    # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–±–∞–≤–ª—è–µ–º –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫)
                    cursor.execute("""
                        CREATE TABLE IF NOT EXISTS blacklisted_users (
                            user_id INTEGER PRIMARY KEY,
                            banned_at TEXT NOT NULL,
                            banned_by INTEGER NOT NULL,
                            reason TEXT DEFAULT ''
                        )
                    """)

                    cursor.execute("""
                        INSERT OR REPLACE INTO blacklisted_users (user_id, banned_at, banned_by, reason)
                        VALUES (?, ?, ?, ?)
                    """, (id_vk, current_time, message.from_id, f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–∏–∫: {reason}"))

                    conn.commit()

                    # –ö–∏–∫–∞–µ–º –∏–∑ –±–µ—Å–µ–¥—ã
                    await bot.api.messages.remove_chat_user(
                        chat_id=message.peer_id - 2000000000,
                        member_id=id_vk
                    )

                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
                    handle_user_leave(id_vk)

                    kick_text = f" (–ø–æ–ª—É—á–µ–Ω–æ {kicks_to_add} –≤—ã–≥–æ–≤–æ—Ä–∞)"
                    await message.answer(f"üî¥ [https://vk.com/id{id_vk}|{name}] –ø–æ–ª—É—á–∏–ª {warns_count} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ(–π){kick_text}\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n‚ö†Ô∏è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–ò–ö: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤—ã–≥–æ–≤–æ—Ä–æ–≤ (3/3)\nüö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–µ—Å–µ–¥—ã!")

                except Exception as e:
                    kick_text = f" (–ø–æ–ª—É—á–µ–Ω–æ {kicks_to_add} –≤—ã–≥–æ–≤–æ—Ä–∞)"
                    await message.answer(f"üî¥ [https://vk.com/id{id_vk}|{name}] –ø–æ–ª—É—á–∏–ª {warns_count} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ(–π){kick_text}\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n‚ö†Ô∏è –õ–ò–ú–ò–¢ –ü–†–ï–í–´–®–ï–ù (3/3) - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∏–∫!\n‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: {str(e)}")
            else:
                kick_text = f" (–ø–æ–ª—É—á–µ–Ω {kicks_to_add} –≤—ã–≥–æ–≤–æ—Ä)" if kicks_to_add == 1 else f" (–ø–æ–ª—É—á–µ–Ω–æ {kicks_to_add} –≤—ã–≥–æ–≤–æ—Ä–∞)"
                await message.answer(f"‚ö†Ô∏è [https://vk.com/id{id_vk}|{name}] –ø–æ–ª—É—á–∏–ª {warns_count} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ(–π){kick_text}\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\nüìä –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –≤—ã–≥: {new_kicks}/3, –ø—Ä–µ–¥: {new_warns}/2")
        else:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            cursor.execute("UPDATE warnings SET warns_count = ? WHERE user_id = ?", (new_warns, id_vk))

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            cursor.execute("""
                INSERT INTO warning_history (user_id, action_type, warns_change, kicks_change, reason, issued_by, issued_at)
                VALUES (?, 'warn', ?, 0, ?, ?, ?)
            """, (id_vk, warns_count, reason, message.from_id, current_time))

            conn.commit()

            await message.answer(f"‚ö†Ô∏è [https://vk.com/id{id_vk}|{name}] –ø–æ–ª—É—á–∏–ª {warns_count} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ(–π)\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\nüìä –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –≤—ã–≥: {new_kicks}/3, –ø—Ä–µ–¥: {new_warns}/2")

@labeler.message(text="/warn <user_arg> <warns_count:int>")
async def warn_user_no_reason(message: Message, user_arg: str, warns_count: int):
    await warn_user_with_reason(message, user_arg, warns_count, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞")

@labeler.message(text="/warn")
async def warn_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'warn'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer("ABot ¬ª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /warn <–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å> <–ö–æ–ª-–≤–æ –ø—Ä–µ–¥.> <–ü—Ä–∏—á–∏–Ω–∞>")

@labeler.message(text="/unwarn <user_arg> <warns_count:int> <reason>")
async def unwarn_user_with_reason(message: Message, user_arg: str, warns_count: int, reason: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'unwarn'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
    user_level = get_admin_level(message.from_id)

    if warns_count <= 0:
        return await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/unwarn <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ö–æ–ª-–≤–æ –ø—Ä–µ–¥.> <–ü—Ä–∏—á–∏–Ω–∞ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/unwarn @id123456789 1 –û—à–∏–±–æ—á–Ω–æ –≤—ã–¥–∞–Ω"
        )

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        cursor.execute("SELECT warns_count, kicks_count FROM warnings WHERE user_id = ?", (id_vk,))
        result = cursor.fetchone()

        if not result:
            return await message.answer(f"‚ùå –£ [https://vk.com/id{id_vk}|{name}] –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π.")

        old_warns, old_kicks = result

        if old_warns == 0 and old_kicks == 0:
            return await message.answer(f"‚ùå –£ [https://vk.com/id{id_vk}|{name}] –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è —Å–Ω—è—Ç–∏—è.")

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π —Å–Ω—è—Ç—å
        total_warns_to_remove = warns_count
        current_warns = old_warns
        current_kicks = old_kicks

        # –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        if current_warns > 0:
            warns_removed = min(current_warns, total_warns_to_remove)
            current_warns -= warns_removed
            total_warns_to_remove -= warns_removed

        # –ï—Å–ª–∏ –µ—â—ë –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤—ã–≥–æ–≤–æ—Ä—ã –≤ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        if total_warns_to_remove > 0 and current_kicks > 0:
            kicks_to_convert = min(current_kicks, (total_warns_to_remove + 1) // 2)
            current_kicks -= kicks_to_convert
            # –ö–∞–∂–¥—ã–π –≤—ã–≥–æ–≤–æ—Ä = 2 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–æ –º—ã –∏—Ö —Å–Ω–∏–º–∞–µ–º
            warnings_from_kicks = kicks_to_convert * 2
            actual_removed = min(warnings_from_kicks, total_warns_to_remove)
            current_warns = actual_removed # –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–Ω—è—Ç—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        cursor.execute("UPDATE warnings SET warns_count = ?, kicks_count = ? WHERE user_id = ?", (current_warns, current_kicks, id_vk))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        cursor.execute("""
            INSERT INTO warning_history (user_id, action_type, warns_change, kicks_change, reason, issued_by, issued_at)
            VALUES (?, 'unwarn', ?, 0, ?, ?, ?)
        """, (id_vk, -warns_count, reason, message.from_id, current_time))

        conn.commit()

        await message.answer(f"‚úÖ –£ [https://vk.com/id{id_vk}|{name}] —Å–Ω—è—Ç–æ {warns_count} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ(–π)\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\nüìä –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –≤—ã–≥: {current_kicks}/3, –ø—Ä–µ–¥: {current_warns}/2")

@labeler.message(text="/unwarn <user_arg> <warns_count:int>")
async def unwarn_user_no_reason(message: Message, user_arg: str, warns_count: int):
    await unwarn_user_with_reason(message, user_arg, warns_count, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞")

@labeler.message(text="/unwarn")
async def unwarn_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'unwarn'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer("ABot ¬ª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unwarn <–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å> <–ö–æ–ª-–≤–æ –ø—Ä–µ–¥.> <–ü—Ä–∏—á–∏–Ω–∞ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>")

@labeler.message(text="/warns <page:int>")
async def warns_list_with_page(message: Message, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'warns'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT w.user_id, a.name, w.kicks_count, w.warns_count
            FROM warnings w
            JOIN admins a ON w.user_id = a.id_vk
            WHERE (w.warns_count > 0 OR w.kicks_count > 0)
            ORDER BY w.kicks_count DESC, w.warns_count DESC
        """)
        users_with_warns = cursor.fetchall()

    if not users_with_warns:
        return await message.answer("ABot ¬ª –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –°—Ç—Ä–∞–Ω–∏—Ü–∞: 1/1\n\n–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏.")

    per_page = 10
    total_pages = (len(users_with_warns) + per_page - 1) // per_page

    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}")

    start = (page - 1) * per_page
    users_slice = users_with_warns[start:start + per_page]

    text = f"ABot ¬ª –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –°—Ç—Ä–∞–Ω–∏—Ü–∞: {page}/{total_pages}\n\n"

    for i, (uid, name, kicks, warns) in enumerate(users_slice, start=start + 1):
        text += f"{i}. [https://vk.com/id{uid}|{name}], –≤—ã–≥: {kicks}/3, –ø—Ä–µ–¥: {warns}/2\n"

    await message.answer(text)

@labeler.message(text="/warns")
async def warns_list_first_page(message: Message):
    if not check_command_access(message.from_id, 'warns'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
    await warns_list_with_page(message, 1)

@labeler.message(text="/warnlist <user_arg> <page:int>")
async def warnlist_with_page(message: Message, user_arg: str, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'warnlist'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/warnlist <–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å> <–°—Ç—Ä–∞–Ω–∏—Ü–∞ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/warnlist @id123456789\n"
            "/warnlist @id123456789 2"
        )

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT action_type, warns_change, kicks_change, reason, issued_by, issued_at
            FROM warning_history
            WHERE user_id = ?
            ORDER BY id DESC
        """, (id_vk,))
        history = cursor.fetchall()

    if not history:
        return await message.answer(f"ABot ¬ª –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è [https://vk.com/id{id_vk}|{name}]:\n\n–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.")

    per_page = 10
    total_pages = (len(history) + per_page - 1) // per_page

    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}")

    start = (page - 1) * per_page
    history_slice = history[start:start + per_page]

    text = f"ABot ¬ª –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è [https://vk.com/id{id_vk}|{name}] (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}):\n\n"

    for action_type, warns_change, kicks_change, reason, issued_by, issued_at in history_slice:
        try:
            issuer_info = await bot.api.users.get(user_ids=[issued_by])
            issuer_name = f"{issuer_info[0].first_name} {issuer_info[0].last_name}"
        except:
            issuer_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        action_text = "–í—ã–¥–∞–Ω–æ" if action_type == "warn" else "–°–Ω—è—Ç–æ"
        warns_text = f"{abs(warns_change)} –ø—Ä–µ–¥."

        if kicks_change > 0:
            warns_text += f" (–ø–æ–ª—É—á–µ–Ω {kicks_change} –≤—ã–≥–æ–≤–æ—Ä)"

        text += f"[{issued_at}] {action_text}: {warns_text}\n"
        text += f"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
        text += f"–ö–µ–º: [https://vk.com/id{issued_by}|{issuer_name}]\n\n"

    await message.answer(text)

@labeler.message(text="/warnlist <user_arg>")
async def warnlist_first_page(message: Message, user_arg: str):
    if not check_command_access(message.from_id, 'warnlist'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
    await warnlist_with_page(message, user_arg, 1)

@labeler.message(text="/warnlist")
async def warnlist_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'warnlist'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer("ABot ¬ª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /warnlist <–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å> <–°—Ç—Ä–∞–Ω–∏—Ü–∞ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>")

@labeler.message(text="/mywarns <page:int>")
async def my_warns_with_page(message: Message, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return

    # –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    id_vk = message.from_id

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        cursor.execute("SELECT warns_count, kicks_count FROM warnings WHERE user_id = ?", (id_vk,))
        current_warns = cursor.fetchone()

        if current_warns:
            warns, kicks = current_warns
        else:
            warns, kicks = 0, 0

        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        cursor.execute("""
            SELECT action_type, warns_change, kicks_change, reason, issued_by, issued_at
            FROM warning_history
            WHERE user_id = ?
            ORDER BY id DESC
        """, (id_vk,))
        history = cursor.fetchall()

    if not history and warns == 0 and kicks == 0:
        return await message.answer("ABot ¬ª –í–∞—à–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:\n\n‚úÖ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π!")

    per_page = 10
    total_pages = (len(history) + per_page - 1) // per_page if history else 1

    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}")

    text = f"ABot ¬ª –í–∞—à–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:\n\nüìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –≤—ã–≥: {kicks}/3, –ø—Ä–µ–¥: {warns}/2\n\n"

    if history:
        start = (page - 1) * per_page
        history_slice = history[start:start + per_page]

        text += f"üìã –ò—Å—Ç–æ—Ä–∏—è (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}):\n\n"

        for action_type, warns_change, kicks_change, reason, issued_by, issued_at in history_slice:
            try:
                issuer_info = await bot.api.users.get(user_ids=[issued_by])
                issuer_name = f"{issuer_info[0].first_name} {issuer_info[0].last_name}"
            except:
                issuer_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            action_text = "–í—ã–¥–∞–Ω–æ" if action_type == "warn" else "–°–Ω—è—Ç–æ"
            warns_text = f"{abs(warns_change)} –ø—Ä–µ–¥."

            if kicks_change > 0:
                warns_text += f" (–ø–æ–ª—É—á–µ–Ω {kicks_change} –≤—ã–≥–æ–≤–æ—Ä)"

            text += f"[{issued_at}] {action_text}: {warns_text}\n"
            text += f"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
            text += f"–ö–µ–º: [https://vk.com/id{issued_by}|{issuer_name}]\n\n"
    else:
        text += "üìã –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—É—Å—Ç–∞."

    await message.answer(text)

@labeler.message(text="/mywarns")
async def my_warns_first_page(message: Message):
    await my_warns_with_page(message, 1)

@labeler.message(text="/unblock <user_arg> <reason>")
async def unblock_user_with_reason(message: Message, user_arg: str, reason: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'unblock'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/unblock <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/unblock @id123456789 –†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è"
        )

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute("SELECT banned_at FROM blacklisted_users WHERE user_id = ?", (id_vk,))
        blocked = cursor.fetchone()

        if not blocked:
            return await message.answer(f"‚ùå [https://vk.com/id{id_vk}|{name}] –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ.")

        # –£–±–∏—Ä–∞–µ–º –∏–∑ —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
        cursor.execute("DELETE FROM blacklisted_users WHERE user_id = ?", (id_vk,))

        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –≤—ã–≥–æ–≤–æ—Ä—ã
        cursor.execute("UPDATE warnings SET warns_count = 0, kicks_count = 0 WHERE user_id = ?", (id_vk,))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        cursor.execute("""
            INSERT INTO warning_history (user_id, action_type, warns_change, kicks_change, reason, issued_by, issued_at)
            VALUES (?, 'unblock', 0, 0, ?, ?, ?)
        """, (id_vk, reason, message.from_id, current_time))

        conn.commit()

    await message.answer(f"‚úÖ [https://vk.com/id{id_vk}|{name}] —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≥–ª–∞—à—ë–Ω –≤ –±–µ—Å–µ–¥—É\nüìù –ü—Ä–∏—á–∏–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {reason}\nüîÑ –í—Å–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –≤—ã–≥–æ–≤–æ—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã")

@labeler.message(text="/unblock <user_arg>")
async def unblock_user_no_reason(message: Message, user_arg: str):
    await unblock_user_with_reason(message, user_arg, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞")

@labeler.message(text="/unblock")
async def unblock_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'unblock'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    await message.answer(
        "ABot ¬ª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /unblock:\n\n"
        "/unblock <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
        "/unblock <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/unblock @id123456789\n"
        "/unblock 123456789 –†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è\n"
        "/unblock https://vk.com/id123456789 –û—à–∏–±–æ—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"
    )

@labeler.message(text="/blocked")
async def blocked_list(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'blocked'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT b.user_id, a.name, b.banned_at, b.reason, b.banned_by
            FROM blacklisted_users b
            LEFT JOIN admins a ON b.user_id = a.id_vk
            ORDER BY b.banned_at DESC
        """)
        blocked_users = cursor.fetchall()

    if not blocked_users:
        return await message.answer("ABot ¬ª –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç.")

    text = "ABot ¬ª –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n\n"
    for uid, name, banned_at, reason, banned_by in blocked_users:
        user_name = name if name else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–µ–≥–æ
        try:
            banner_info = await bot.api.users.get(user_ids=[banned_by])
            banner_name = f"{banner_info[0].first_name} {banner_info[0].last_name}"
        except:
            banner_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        text += f"üö´ [https://vk.com/id{uid}|{user_name}]\n"
        text += f"   –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {banned_at}\n"
        text += f"   –ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
        text += f"   –ö–µ–º: [https://vk.com/id{banned_by}|{banner_name}]\n\n"

    await message.answer(text)

@labeler.message(text="/mute <user_arg> <duration> <reason>")
async def mute_user_with_duration_reason(message: Message, user_arg: str, duration: str, reason: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'mute'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∑–∞–≥–ª—É—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/mute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–í—Ä–µ–º—è> <–ü—Ä–∏—á–∏–Ω–∞>\n"
            "/mute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> –Ω–∞–≤—Å–µ–≥–¥–∞ <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/mute @id123456789 30–º –°–ø–∞–º\n"
            "/mute 123456789 1—á –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª\n"
            "/mute https://vk.com/id123456789 –Ω–∞–≤—Å–µ–≥–¥–∞ –§–ª—É–¥"
        )

    target_level = get_admin_level(id_vk)
    if target_level >= get_admin_level(message.from_id):
        return await message.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–≥–ª—É—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ.")

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    await get_user_data(id_vk, auto_track_join=False)

    current_time = get_moscow_time()
    current_time_str = current_time.strftime("%d.%m.%Y %H:%M:%S")

    # –ü–∞—Ä—Å–∏–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥–ª—É—à–µ–Ω–∏—è
    muted_until = ""
    duration_text = ""

    if duration.lower() in ["–Ω–∞–≤—Å–µ–≥–¥–∞", "forever", "permanent"]:
        muted_until = ""
        duration_text = "–Ω–∞–≤—Å–µ–≥–¥–∞"
    else:
        # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è (30–º, 1—á, 2–¥ –∏ —Ç.–¥.)
        import re
        time_match = re.match(r'(\d+)([–º—á–¥hmd])', duration.lower())
        if time_match:
            amount = int(time_match.group(1))
            unit = time_match.group(2)

            if unit in ['–º', 'm']:
                delta = timedelta(minutes=amount)
                duration_text = f"{amount} –º–∏–Ω—É—Ç"
            elif unit in ['—á', 'h']:
                delta = timedelta(hours=amount)
                duration_text = f"{amount} —á–∞—Å–æ–≤"
            elif unit in ['–¥', 'd']:
                delta = timedelta(days=amount)
                duration_text = f"{amount} –¥–Ω–µ–π"
            else:
                return await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: 30–º, 1—á, 2–¥ –∏–ª–∏ '–Ω–∞–≤—Å–µ–≥–¥–∞'")

            muted_until_dt = current_time + delta
            muted_until = muted_until_dt.strftime("%Y-%m-%d %H:%M:%S")
        else:
            return await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: 30–º, 1—á, 2–¥ –∏–ª–∏ '–Ω–∞–≤—Å–µ–≥–¥–∞'")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute("SELECT muted_at FROM muted_users WHERE user_id = ?", (id_vk,))
        already_muted = cursor.fetchone()

        if already_muted:
            return await message.answer(f"‚ùå [https://vk.com/id{id_vk}|{name}] —É–∂–µ –∑–∞–≥–ª—É—à–µ–Ω.")

        # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö
        cursor.execute("""
            INSERT INTO muted_users (user_id, muted_at, muted_by, muted_until, reason)
            VALUES (?, ?, ?, ?, ?)
        """, (id_vk, current_time_str, message.from_id, muted_until, reason))

        conn.commit()

    await message.answer(f"üîá [https://vk.com/id{id_vk}|{name}] –∑–∞–≥–ª—É—à–µ–Ω –Ω–∞ {duration_text}\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}")

@labeler.message(text="/mute <user_arg> <duration>")
async def mute_user_with_duration(message: Message, user_arg: str, duration: str):
    await mute_user_with_duration_reason(message, user_arg, duration, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞")

@labeler.message(text="/mute <user_arg>")
async def mute_user_no_duration(message: Message, user_arg: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'mute'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∑–∞–≥–ª—É—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /mute:\n\n"
        "/mute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–í—Ä–µ–º—è> <–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>\n\n"
        "‚è∞ –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏:\n"
        "‚Ä¢ 30–º - 30 –º–∏–Ω—É—Ç\n"
        "‚Ä¢ 1—á - 1 —á–∞—Å\n"
        "‚Ä¢ 2–¥ - 2 –¥–Ω—è\n"
        "‚Ä¢ –Ω–∞–≤—Å–µ–≥–¥–∞ - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/mute @id123456789 30–º –°–ø–∞–º\n"
        "/mute 123456789 1—á\n"
        "/mute https://vk.com/id123456789 –Ω–∞–≤—Å–µ–≥–¥–∞ –§–ª—É–¥"
    )

@labeler.message(text="/mute")
async def mute_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'mute'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∑–∞–≥–ª—É—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /mute:\n\n"
        "/mute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–í—Ä–µ–º—è> <–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>\n\n"
        "‚è∞ –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏:\n"
        "‚Ä¢ 30–º - 30 –º–∏–Ω—É—Ç\n"
        "‚Ä¢ 1—á - 1 —á–∞—Å\n"
        "‚Ä¢ 2–¥ - 2 –¥–Ω—è\n"
        "‚Ä¢ –Ω–∞–≤—Å–µ–≥–¥–∞ - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/mute @id123456789 30–º –°–ø–∞–º\n"
        "/mute 123456789 1—á\n"
        "/mute https://vk.com/id123456789 –Ω–∞–≤—Å–µ–≥–¥–∞ –§–ª—É–¥"
    )

@labeler.message(text="/unmute <user_arg> <reason>")
async def unmute_user_with_reason(message: Message, user_arg: str, reason: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'unmute'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Å–Ω–∏–º–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    id_vk = await extract_user_id(user_arg)
    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/unmute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/unmute @id123456789 –ò—Å–ø—Ä–∞–≤–∏–ª—Å—è"
        )

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥–ª—É—à–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute("SELECT muted_at FROM muted_users WHERE user_id = ?", (id_vk,))
        muted = cursor.fetchone()

        if not muted:
            return await message.answer(f"‚ùå [https://vk.com/id{id_vk}|{name}] –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω.")

        # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        cursor.execute("DELETE FROM muted_users WHERE user_id = ?", (id_vk,))
        conn.commit()

    await message.answer(f"üîä –ó–∞–≥–ª—É—à–∫–∞ —Å–Ω—è—Ç–∞ —Å [https://vk.com/id{id_vk}|{name}]\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}")

@labeler.message(text="/unmute <user_arg>")
async def unmute_user_no_reason(message: Message, user_arg: str):
    await unmute_user_with_reason(message, user_arg, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞")

@labeler.message(text="/unmute")
async def unmute_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'unmute'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Å–Ω–∏–º–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")

    await message.answer(
        "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /unmute:\n\n"
        "/unmute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å>\n"
        "/unmute <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/unmute @id123456789\n"
        "/unmute 123456789 –ò—Å–ø—Ä–∞–≤–∏–ª—Å—è\n"
        "/unmute https://vk.com/id123456789 –û—à–∏–±–æ—á–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞"
    )

@labeler.message(text="/muted")
async def muted_list(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'muted'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    current_time = get_moscow_time()

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT m.user_id, a.name, m.muted_at, m.muted_until, m.reason, ma.name as muted_by_name
            FROM muted_users m
            LEFT JOIN admins a ON m.user_id = a.id_vk
            LEFT JOIN admins ma ON m.muted_by = ma.id_vk
            ORDER BY m.muted_at DESC
        """)
        muted_users = cursor.fetchall()

    if not muted_users:
        return await message.answer("ABot ¬ª –°–ø–∏—Å–æ–∫ –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç.")

    text = "ABot ¬ª –ó–∞–≥–ª—É—à–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n\n"
    expired_users = []

    for uid, name, muted_at, muted_until, reason, muted_by_name in muted_users:
        user_name = name if name else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        muter_name = muted_by_name if muted_by_name else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ –∑–∞–≥–ª—É—à–∫–∞
        is_expired = False
        if muted_until and muted_until != '':
            try:
                until_dt = datetime.strptime(muted_until, "%Y-%m-%d %H:%M:%S")
                until_dt = until_dt.replace(tzinfo=MSK_TZ)
                if current_time > until_dt:
                    is_expired = True
                    expired_users.append(uid)
            except:
                pass

        if is_expired:
            continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å—Ç—ë–∫—à–∏–µ –∑–∞–≥–ª—É—à–∫–∏

        text += f"üîá [https://vk.com/id{uid}|{user_name}]\n"
        text += f"   –ó–∞–≥–ª—É—à–µ–Ω: {muted_at}\n"

        if muted_until and muted_until != '':
            try:
                until_dt = datetime.strptime(muted_until, "%Y-%m-%d %H:%M:%S")
                until_display = until_dt.strftime("%d.%m.%Y %H:%M")
                text += f"   –î–æ: {until_display}\n"
            except:
                text += f"   –î–æ: –Ω–∞–≤—Å–µ–≥–¥–∞\n"
        else:
            text += f"   –î–æ: –Ω–∞–≤—Å–µ–≥–¥–∞\n"

        text += f"   –ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
        text += f"   –ö–µ–º: [https://vk.com/id{muted_by_name}|{muter_name}]\n\n"

    # –£–¥–∞–ª—è–µ–º –∏—Å—Ç—ë–∫—à–∏–µ –∑–∞–≥–ª—É—à–∫–∏
    if expired_users:
        cursor.execute(f"DELETE FROM muted_users WHERE user_id IN ({','.join(['?' for _ in expired_users])})", expired_users)
        conn.commit()

    if text == "ABot ¬ª –ó–∞–≥–ª—É—à–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n\n":
        text = "ABot ¬ª –°–ø–∏—Å–æ–∫ –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç."

    await message.answer(text)

@labeler.message(text="/top <page:int>")
async def top_users_with_page(message: Message, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'top'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT id_vk, name, msg_count 
            FROM admins 
            WHERE msg_count > 0 AND is_in_chat = 1
            ORDER BY msg_count DESC
        """)
        all_users = cursor.fetchall()

    if not all_users:
        return await message.answer("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞.")

    per_page = 20
    total_pages = (len(all_users) + per_page - 1) // per_page

    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}")

    # –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–≥–æ –≤ –æ–±—â–µ–º —Ä–µ–π—Ç–∏–Ω–≥–µ
    requester_place = None
    requester_info = None
    for i, (uid, name, msg_count) in enumerate(all_users, 1):
        if uid == message.from_id:
            requester_place = i
            requester_info = (name, msg_count)
            break

    start = (page - 1) * per_page
    users_slice = all_users[start:start + per_page]

    text = f"ABot ¬ª –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π ({page}/{total_pages}):\n\n"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–≥–æ, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
    if requester_place and requester_info:
        text += f"–í–∞—à–µ –º–µ—Å—Ç–æ: {requester_place}. [https://vk.com/id{message.from_id}|{requester_info[0]}] ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–π: {requester_info[1]}\n\n"

    for i, (uid, name, msg_count) in enumerate(users_slice, start=start + 1):
        text += f"{i}. [https://vk.com/id{uid}|{name}] ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–π: {msg_count}\n"

    await message.answer(text)

@labeler.message(text="/top")
async def top_users_first_page(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'top'):
        return await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
    await top_users_with_page(message, 1)

@labeler.message(text="/accommand list")
async def accommand_list(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'accommand'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT command_name, required_level, is_disabled 
            FROM command_restrictions 
            ORDER BY required_level ASC, command_name ASC
        """)
        commands = cursor.fetchall()

    if not commands:
        return await message.answer("ABot ¬ª –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ø—É—Å—Ç.")

    text = "ABot ¬ª –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–º–∞–Ω–¥–∞–º:\n\n"

    for cmd, level, disabled in commands:
        status = "üî¥ –û–¢–ö–õ–Æ–ß–ï–ù–ê" if disabled else f"üü¢ –£—Ä–æ–≤–µ–Ω—å {level}"
        text += f"/{cmd} - {status}\n"

    text += "\nüí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n"
    text += "/accommand set <–∫–æ–º–∞–Ω–¥–∞> <—É—Ä–æ–≤–µ–Ω—å>\n"
    text += "/accommand disable <–∫–æ–º–∞–Ω–¥–∞>\n"
    text += "/accommand enable <–∫–æ–º–∞–Ω–¥–∞>"

    await message.answer(text)

@labeler.message(text="/accommand set <command> <level:int>")
async def accommand_set_level(message: Message, command: str, level: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'accommand'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    if level < 0 or level > 6:
        return await message.answer("‚ùå –£—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 6.")

    current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            INSERT OR REPLACE INTO command_restrictions 
            (command_name, required_level, is_disabled, modified_by, modified_at)
            VALUES (?, ?, 0, ?, ?)
        """, (command, level, message.from_id, current_time))
        conn.commit()

    await message.answer(f"‚úÖ –ö–æ–º–∞–Ω–¥–∞ /{command} —Ç–µ–ø–µ—Ä—å —Ç—Ä–µ–±—É–µ—Ç —É—Ä–æ–≤–µ–Ω—å {level}")

@labeler.message(text="/accommand disable <command>")
async def accommand_disable(message: Message, command: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'accommand'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            INSERT OR REPLACE INTO command_restrictions 
            (command_name, required_level, is_disabled, modified_by, modified_at)
            VALUES (?, (SELECT COALESCE(required_level, 0) FROM command_restrictions WHERE command_name = ?), 1, ?, ?)
        """, (command, command, message.from_id, current_time))
        conn.commit()

    await message.answer(f"üî¥ –ö–æ–º–∞–Ω–¥–∞ /{command} –æ—Ç–∫–ª—é—á–µ–Ω–∞")

@labeler.message(text="/accommand enable <command>")
async def accommand_enable(message: Message, command: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'accommand'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    current_time = get_moscow_time().strftime("%Y-%m-%d %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE command_restrictions 
            SET is_disabled = 0, modified_by = ?, modified_at = ?
            WHERE command_name = ?
        """, (message.from_id, current_time, command))

        if cursor.rowcount == 0:
            return await message.answer(f"‚ùå –ö–æ–º–∞–Ω–¥–∞ /{command} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.")

        conn.commit()

    await message.answer(f"üü¢ –ö–æ–º–∞–Ω–¥–∞ /{command} –≤–∫–ª—é—á–µ–Ω–∞")

@labeler.message(text="/accommand")
async def accommand_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'accommand'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "ABot ¬ª –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–º–∞–Ω–¥–∞–º (—É—Ä–æ–≤–µ–Ω—å 6):\n\n"
        "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/accommand list - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∏ –∏—Ö —É—Ä–æ–≤–Ω–µ–π\n"
        "/accommand set <–∫–æ–º–∞–Ω–¥–∞> <—É—Ä–æ–≤–µ–Ω—å> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞\n"
        "/accommand disable <–∫–æ–º–∞–Ω–¥–∞> - –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É\n"
        "/accommand enable <–∫–æ–º–∞–Ω–¥–∞> - –í–∫–ª—é—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/accommand set kick 5 - –ö–æ–º–∞–Ω–¥–∞ /kick —Ç—Ä–µ–±—É–µ—Ç 5 —É—Ä–æ–≤–µ–Ω—å\n"
        "/accommand disable warn - –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /warn\n"
        "/accommand enable warn - –í–∫–ª—é—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /warn"
    )

@labeler.message(text="/greetings add <greeting_text>")
async def greetings_add(message: Message, greeting_text: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            INSERT INTO greetings (text, wait_seconds, created_by, created_at)
            VALUES (?, 0, ?, ?)
        """, (greeting_text, message.from_id, current_time))

        greeting_id = cursor.lastrowid
        conn.commit()

    await message.answer(f"‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å ID {greeting_id}\nüìù –¢–µ–∫—Å—Ç: {greeting_text}")

@labeler.message(text="/greetings set <greeting_id:int>")
async def greetings_set_active(message: Message, greeting_id: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        cursor.execute("SELECT text FROM greetings WHERE id = ?", (greeting_id,))
        greeting = cursor.fetchone()

        if not greeting:
            return await message.answer(f"‚ùå –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å ID {greeting_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        cursor.execute("""
            INSERT OR REPLACE INTO greeting_settings (key, value)
            VALUES ('active_greeting_id', ?)
        """, (str(greeting_id),))

        conn.commit()

    await message.answer(f"‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å ID {greeting_id} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ\nüìù –¢–µ–∫—Å—Ç: {greeting[0]}")

@labeler.message(text="/greetings setwait <greeting_id:int> <wait_seconds:int>")
async def greetings_set_wait(message: Message, greeting_id: int, wait_seconds: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    if wait_seconds < 0 or wait_seconds > 300:
        return await message.answer("‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ 300 —Å–µ–∫—É–Ω–¥.")

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        cursor.execute("SELECT text FROM greetings WHERE id = ?", (greeting_id,))
        greeting = cursor.fetchone()

        if not greeting:
            return await message.answer(f"‚ùå –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å ID {greeting_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
        cursor.execute("""
            UPDATE greetings SET wait_seconds = ?, modified_by = ?, modified_at = ?
            WHERE id = ?
        """, (wait_seconds, message.from_id, current_time, greeting_id))

        conn.commit()

    await message.answer(f"‚úÖ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è {greeting_id} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {wait_seconds} —Å–µ–∫—É–Ω–¥")

@labeler.message(text="/greetings edit <greeting_id:int> <new_text>")
async def greetings_edit(message: Message, greeting_id: int, new_text: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        cursor.execute("SELECT text FROM greetings WHERE id = ?", (greeting_id,))
        greeting = cursor.fetchone()

        if not greeting:
            return await message.answer(f"‚ùå –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å ID {greeting_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        cursor.execute("""
            UPDATE greetings SET text = ?, modified_by = ?, modified_at = ?
            WHERE id = ?
        """, (new_text, message.from_id, current_time, greeting_id))

        conn.commit()

    await message.answer(f"‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ {greeting_id} –æ–±–Ω–æ–≤–ª–µ–Ω–æ\nüìù –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç: {new_text}")

@labeler.message(text="/greetings get")
async def greetings_get_active(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        cursor.execute("SELECT value FROM greeting_settings WHERE key = 'active_greeting_id'")
        active_greeting = cursor.fetchone()

        if not active_greeting or not active_greeting[0]:
            return await message.answer("‚ùå –ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")

        greeting_id = int(active_greeting[0])

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏
        cursor.execute("""
            SELECT text, wait_seconds, created_by, created_at, modified_by, modified_at
            FROM greetings WHERE id = ?
        """, (greeting_id,))
        greeting_data = cursor.fetchone()

        if not greeting_data:
            return await message.answer("‚ùå –ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")

        text, wait_seconds, created_by, created_at, modified_by, modified_at = greeting_data

        try:
            creator_info = await bot.api.users.get(user_ids=[created_by])
            creator_name = f"{creator_info[0].first_name} {creator_info[0].last_name}"
        except:
            creator_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    response = f"ABot ¬ª –¢–µ–∫—É—â–µ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (ID {greeting_id}):\n\n"
    response += f"üìù –¢–µ–∫—Å—Ç: {text}\n"
    response += f"‚è∞ –ó–∞–¥–µ—Ä–∂–∫–∞: {wait_seconds} —Å–µ–∫—É–Ω–¥\n"
    response += f"üë§ –°–æ–∑–¥–∞–ª: {creator_name}\n"
    response += f"üìÖ –°–æ–∑–¥–∞–Ω–æ: {created_at}\n"

    if modified_by and modified_at:
        try:
            modifier_info = await bot.api.users.get(user_ids=[modified_by])
            modifier_name = f"{modifier_info[0].first_name} {modifier_info[0].last_name}"
        except:
            modifier_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        response += f"‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ: [https://vk.com/id{modified_by}|{modifier_name}] ({modified_at})"

    await message.answer(response)

@labeler.message(text="/greetings get <greeting_id:int>")
async def greetings_get_specific(message: Message, greeting_id: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT text, wait_seconds, created_by, created_at, modified_by, modified_at
            FROM greetings WHERE id = ?
        """, (greeting_id,))
        greeting_data = cursor.fetchone()

        if not greeting_data:
            return await message.answer(f"‚ùå –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å ID {greeting_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

        text, wait_seconds, created_by, created_at, modified_by, modified_at = greeting_data

        try:
            creator_info = await bot.api.users.get(user_ids=[created_by])
            creator_name = f"{creator_info[0].first_name} {creator_info[0].last_name}"
        except:
            creator_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT value FROM greeting_settings WHERE key = 'active_greeting_id'")
        active_greeting = cursor.fetchone()
        is_active = active_greeting and active_greeting[0] == str(greeting_id)

    status = "üü¢ –ê–ö–¢–ò–í–ù–û–ï" if is_active else "üî¥ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ"

    response = f"ABot ¬ª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ ID {greeting_id} ({status}):\n\n"
    response += f"üìù –¢–µ–∫—Å—Ç: {text}\n"
    response += f"‚è∞ –ó–∞–¥–µ—Ä–∂–∫–∞: {wait_seconds} —Å–µ–∫—É–Ω–¥\n"
    response += f"üë§ –°–æ–∑–¥–∞–ª: {creator_name}\n"
    response += f"üìÖ –°–æ–∑–¥–∞–Ω–æ: {created_at}\n"

    if modified_by and modified_at:
        try:
            modifier_info = await bot.api.users.get(user_ids=[modified_by])
            modifier_name = f"{modifier_info[0].first_name} {modifier_info[0].last_name}"
        except:
            modifier_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        response += f"‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ: [https://vk.com/id{modified_by}|{modifier_name}] ({modified_at})"

    await message.answer(response)

@labeler.message(text="/greetings list <page:int>")
async def greetings_list_with_page(message: Message, page: int):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT id, text, wait_seconds, created_by, created_at
            FROM greetings ORDER BY id DESC
        """)
        all_greetings = cursor.fetchall()

        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        cursor.execute("SELECT value FROM greeting_settings WHERE key = 'active_greeting_id'")
        active_greeting = cursor.fetchone()
        active_id = int(active_greeting[0]) if active_greeting and active_greeting[0] else None

    if not all_greetings:
        return await message.answer("üìù –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –ø—É—Å—Ç.")

    per_page = 10
    total_pages = (len(all_greetings) + per_page - 1) // per_page

    if page < 1 or page > total_pages:
        return await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {total_pages}")

    start = (page - 1) * per_page
    greetings_slice = all_greetings[start:start + per_page]

    text = f"ABot ¬ª –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}):\n\n"

    for greeting_id, greeting_text, wait_seconds, created_by, created_at in greetings_slice:
        status = "üü¢" if greeting_id == active_id else "üî¥"

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
        short_text = greeting_text[:50] + "..." if len(greeting_text) > 50 else greeting_text

        try:
            creator_info = await bot.api.users.get(user_ids=[created_by])
            creator_name = f"{creator_info[0].first_name} {creator_info[0].last_name}"
        except:
            creator_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        text += f"{status} ID {greeting_id}: {short_text}\n"
        text += f"   ‚è∞ {wait_seconds}—Å | üë§ {creator_name} | üìÖ {created_at}\n\n"

    await message.answer(text)

@labeler.message(text="/greetings list")
async def greetings_list_first_page(message: Message):
    await greetings_list_with_page(message, 1)

@labeler.message(text="/greetings")
async def greetings_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'greetings'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "ABot ¬ª –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n\n"
        "/greetings add <–¢–µ–∫—Å—Ç> - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "/greetings set <ID –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "/greetings setwait <ID –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è> <–ö–æ–ª-–≤–æ —Å–µ–∫—É–Ω–¥> - –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è\n"
        "/greetings edit <ID –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è> <–¢–µ–∫—Å—Ç> - –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç\n"
        "/greetings get - –í—ã–≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "/greetings get <ID –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è> - –í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏\n"
        "/greetings list <–°—Ç—Ä–∞–Ω–∏—Ü–∞> - –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π\n\n"
        "üí° –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:\n"
        "{name} - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
        "{id} - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n"
        "‚è∞ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: –æ—Ç 0 –¥–æ 300 —Å–µ–∫—É–Ω–¥"
    )

# üö´ –°–ò–°–¢–ï–ú–ù–´–ô –ë–ê–ù - –ü–û–õ–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
@labeler.message(text="/ban <user_arg> <reason>")
async def ban_user_with_reason(message: Message, user_arg: str, reason: str):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'ban'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    user_level = get_admin_level(message.from_id)
    id_vk = await extract_user_id(user_arg)

    if not id_vk:
        return await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
            "üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/ban <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
            "üí° –ü—Ä–∏–º–µ—Ä:\n"
            "/ban @id123456789 —Å–∂—à–Ω–∏–∫"
        )

    target_level = get_admin_level(id_vk)
    if target_level >= user_level:
        return await message.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ.")

    current_time = get_moscow_time().strftime("%d.%m.%Y %H:%M:%S")

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
        cursor.execute("SELECT banned_at FROM blacklisted_users WHERE user_id = ?", (id_vk,))
        is_blocked = cursor.fetchone()

        if is_blocked:
            return await message.answer(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {id_vk} —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")

        # –î–æ–±–∞–≤–ª—è–µ–º –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
        cursor.execute("""
            INSERT INTO blacklisted_users (user_id, banned_at, banned_by, reason)
            VALUES (?, ?, ?, ?)
        """, (id_vk, current_time, message.from_id, reason))

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –≤—ã–≥–æ–≤–æ—Ä—ã
        cursor.execute("UPDATE warnings SET warns_count = 0, kicks_count = 0 WHERE user_id = ?", (id_vk,))

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        cursor.execute("""
            INSERT INTO warning_history (user_id, action_type, warns_change, kicks_change, reason, issued_by, issued_at)
            VALUES (?, 'ban', 0, 0, ?, ?, ?)
        """, (id_vk, reason, message.from_id, current_time))

        conn.commit()

    try:
        user_info = await bot.api.users.get(user_ids=[id_vk])
        name = f"{user_info[0].first_name} {user_info[0].last_name}"
    except:
        name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    await message.answer(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [https://vk.com/id{id_vk}|{name}] –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}")

@labeler.message(text="/ban <user_arg>")
async def ban_user_no_reason(message: Message, user_arg: str):
    await ban_user_with_reason(message, user_arg, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞")

@labeler.message(text="/ban")
async def ban_help(message: Message):
    if message.peer_id != TARGET_PEER_ID:
        return
    if not check_command_access(message.from_id, 'ban'):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")

    await message.answer(
        "ABot ¬ª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /ban:\n\n"
        "/ban <–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> <–ü—Ä–∏—á–∏–Ω–∞>\n\n"
        "üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "/ban @id123456789 –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª\n"
        "/ban 123456789 —Å–∂—à–Ω–∏–∫\n"
        "/ban https://vk.com/id123456789 –°–ø–∞–º"
    )


async def on_startup():
    """–§—É–Ω–∫—Ü–∏—è, –≤—ã–ø–æ–ª–Ω—è–µ–º–∞—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"""
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    global current_chat_peer_id
    current_chat_peer_id = TARGET_PEER_ID

    # –í—ã–ø–æ–ª–Ω—è–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã
    await one_time_reset_chat_users()

    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ—Å–µ–¥—ã
    await sync_chat_members()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –ú–ì–ù–û–í–ï–ù–ù–û–ô –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–∞–∫—Ü–∏–π –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@bot.on.raw_event("message_reaction_event") 
async def handle_reaction_event(event):
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ event
        event_data = event.object if hasattr(event, 'object') else event

        peer_id = event_data.get('peer_id')
        if peer_id != TARGET_PEER_ID:
            return

        user_id = event_data.get('user_id')
        if not user_id:
            return

        # –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –º—É—Ç–∞
        if is_user_muted(user_id):
            reaction_id = event_data.get('reaction_id')
            cmid = event_data.get('cmid')

            if reaction_id and cmid:
                # –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é –ë–ï–ó –∑–∞–¥–µ—Ä–∂–µ–∫
                await bot.api.messages.delete_reaction(
                    peer_id=TARGET_PEER_ID,
                    cmid=cmid,
                    reaction_id=reaction_id
                )
                print(f"üö´ –ë–õ–û–ö–ò–†–û–í–ö–ê: —É–¥–∞–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –æ—Ç –∑–∞–≥–ª—É—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏: {e}")

# üö´ –°–ò–°–¢–ï–ú–ù–´–ô –ú–£–¢ - –ü–û–õ–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –û–ë–©–ï–ù–ò–Ø
async def system_mute_check(message: Message) -> bool:
    """
    –°–ò–°–¢–ï–ú–ù–´–ô –ú–£–¢ - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –í–°–Å –æ–±—â–µ–Ω–∏–µ –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥–ª—É—à–µ–Ω –∏ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
    """
    # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º—É—Ç–∞
    if not is_user_muted(message.from_id):
        return False

    # –ú–ì–ù–û–í–ï–ù–ù–û–ï —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥–ª—É—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await bot.api.messages.delete(
            cmids=[message.conversation_message_id],
            peer_id=message.peer_id,
            delete_for_all=True
        )
        print(f"üö´ –°–ò–°–¢–ï–ú–ù–´–ô –ú–£–¢: –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_id}")

        # –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
        if message.from_id not in mute_notifications_sent:
            await send_mute_notification(message.from_id)

        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º—É—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_id}: {e}")
        return True

async def send_mute_notification(user_id: int):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –æ–±—â–µ–Ω–∏—è"""
    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT reason, muted_until FROM muted_users WHERE user_id = ?", (user_id,))
            mute_info = cursor.fetchone()

            if mute_info:
                reason, muted_until = mute_info
                if muted_until and muted_until != '':
                    try:
                        until_dt = datetime.strptime(muted_until, "%Y-%m-%d %H:%M:%S")
                        until_display = until_dt.strftime("%d.%m.%Y %H:%M")
                        duration_text = f"–¥–æ {until_display}"
                    except:
                        duration_text = "–Ω–∞–≤—Å–µ–≥–¥–∞"
                else:
                    duration_text = "–Ω–∞–≤—Å–µ–≥–¥–∞"

                import random
                try:
                    await bot.api.messages.send(
                        peer_id=user_id,
                        message=f"üö´ –°–ò–°–¢–ï–ú–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –û–ë–©–ï–ù–ò–Ø\n\n‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç {duration_text}\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n‚ùå –í–´ –ù–ï –ú–û–ñ–ï–¢–ï –û–ë–©–ê–¢–¨–°–Ø –í –ë–ï–°–ï–î–ï!\nüö´ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ä–µ–∞–∫—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ\nüîÑ –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –ª—é–±—ã–µ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è\n\nüí° –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏",
                        random_id=random.randint(1, 2**31)
                    )
                    print(f"üì© –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                    mute_notifications_sent.add(user_id)
                except Exception as ls_error:
                    if "cannot start a conversation" in str(ls_error).lower() or "without permission" in str(ls_error).lower():
                        print(f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –õ–° –æ—Ç –±–æ—Ç–æ–≤")
                        mute_notifications_sent.add(user_id)
                    else:
                        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {ls_error}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")

def is_user_muted(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–≥–ª—É—à–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
    try:
        current_time = get_moscow_time()
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT muted_until FROM muted_users WHERE user_id = ?", (user_id,))
            result = cursor.fetchone()

            if result:
                muted_until_str = result[0]
                if muted_until_str and muted_until_str != '':
                    muted_until_dt = datetime.strptime(muted_until_str, "%Y-%m-%d %H:%M:%S")
                    muted_until_dt = muted_until_dt.replace(tzinfo=MSK_TZ)
                    if current_time > muted_until_dt:
                        # –ó–∞–≥–ª—É—à–∫–∞ –∏—Å—Ç–µ–∫–ª–∞, —É–¥–∞–ª—è–µ–º
                        cursor.execute("DELETE FROM muted_users WHERE user_id = ?", (user_id,))
                        conn.commit()
                        return False
                    else:
                        return True # –ó–∞–≥–ª—É—à–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                else:
                    return True # –ó–∞–≥–ª—É—à–∫–∞ –Ω–∞–≤—Å–µ–≥–¥–∞
            else:
                return False # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–≥–ª—É—à–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        return False # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–°–õ–ï–î–ù–ò–ú!)
@labeler.message()
async def track_all_messages_final(message: Message):
    global current_chat_peer_id

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º peer_id –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    if not current_chat_peer_id:
        current_chat_peer_id = message.peer_id
        print(f"üîó –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω peer_id –±–µ—Å–µ–¥—ã: {current_chat_peer_id}")
        await sync_chat_members()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ü–µ–ª–µ–≤–æ–π –±–µ—Å–µ–¥—ã
    if message.peer_id != TARGET_PEER_ID:
        return

    # –°–ò–°–¢–ï–ú–ù–´–ô –ú–£–¢ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if await system_mute_check(message):
        return  # –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, –¥–∞–ª—å—à–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º

    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    await auto_track_member_changes(message)

    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await get_user_data(message.from_id)

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    update_message_count(message.from_id)

    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–∞–∂–¥–æ–µ 10-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    import random
    if random.randint(1, 10) == 1:
        await sync_chat_members()

if __name__ == "__main__":
    init_db()
    bot.labeler.load(labeler)

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞
    bot.loop_wrapper.on_startup.append(on_startup())

    bot.run_forever()